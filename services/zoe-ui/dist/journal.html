<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Zoe - Journal</title>
    <style>
        * { 
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: linear-gradient(135deg, #fafbfc 0%, #f1f3f6 100%);
            min-height: 100vh; color: #333;
            font-size: clamp(14px, 1.6vw, 16px);
        }
        
        /* Navigation */
        .nav-bar {
            position: fixed; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px; z-index: 100; display: flex; justify-content: space-between;
            align-items: center; height: 60px;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .mini-orb { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            cursor: pointer; transition: all 0.3s ease; min-width: 44px; min-height: 44px;
        }
        .mini-orb:hover { transform: scale(1.1); }
        .nav-menu { display: flex; gap: 20px; }
        .nav-item { 
            color: #666; text-decoration: none; font-size: 13px; font-weight: 400; 
            transition: all 0.3s ease; padding: 8px 12px; border-radius: 6px;
            min-height: 44px; display: flex; align-items: center;
        }
        .nav-item:hover, .nav-item.active { color: #7B61FF; background: rgba(123, 97, 255, 0.1); }
        .nav-right { display: flex; align-items: center; gap: 10px; }
        
        .more-nav-btn { 
            color: #666; text-decoration: none; font-size: 13px; font-weight: 400; 
            transition: all 0.3s ease; padding: 8px 12px; border-radius: 6px;
            min-height: 44px; display: flex; align-items: center; cursor: pointer;
            background: none; border: none;
        }
        .more-nav-btn:hover { color: #7B61FF; background: rgba(123, 97, 255, 0.1); }
        
        .settings-btn { 
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: all 0.3s ease; color: #666;
            font-size: 16px; font-weight: bold;
        }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.8); color: #333; }
        
        .api-indicator { font-size: 12px; padding: 4px 8px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .api-indicator.online { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .api-indicator.offline { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .api-indicator.warning { background: rgba(251, 146, 60, 0.1); color: #ea580c; }
        .api-indicator::before { content: ''; width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .api-indicator.online::before { background: #22c55e; }
        .api-indicator.offline::before { background: #ef4444; }
        .api-indicator.warning::before { background: #ea580c; }

        /* Main Layout */
        .main-container { 
            padding: 70px 20px 20px; height: 100vh; display: flex; flex-direction: column;
        }
        
        .top-info-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding: 0 10px;
        }
        .time-display { display: flex; flex-direction: column; }
        .current-time { font-size: 18px; font-weight: 300; color: #333; }
        .current-date { font-size: 11px; color: #666; margin-top: 2px; }
        .weather-widget { display: flex; align-items: center; gap: 6px; }

        /* Book-like Journal */
        .journal-layout {
            flex: 1; display: flex; align-items: center; justify-content: center;
            width: 100%; height: calc(100vh - 150px);
            position: relative; padding: 0 20px;
        }
        .book {
            width: 100%; height: 100%; display: grid; grid-template-columns: 1fr 24px 1fr; gap: 0;
            background: transparent; position: relative;
        }
        .page {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 14px; padding: 18px;
            overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(123, 97, 255, 0.06);
        }
        .spine {
            width: 24px; background: linear-gradient(180deg, rgba(123,97,255,0.2), rgba(90,224,224,0.2));
            border-left: 1px solid rgba(255,255,255,0.6); border-right: 1px solid rgba(255,255,255,0.6);
            border-radius: 8px; box-shadow: inset 0 0 8px rgba(0,0,0,0.06);
        }
        .page-header {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
        }
        .date-header {
            font-size: 16px; font-weight: 500; color: #333; padding: 8px 12px; border-radius: 10px;
            background: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.6); cursor: pointer;
            transition: all 0.2s ease; min-height: 44px; display: inline-flex; align-items: center; gap: 8px;
        }
        .date-header:hover { background: rgba(255,255,255,0.9); }
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer;
            background: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.6);
            display: flex; align-items: center; justify-content: center; font-size: 22px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); transition: all 0.2s ease; z-index: 50;
        }
        .nav-arrow:hover { background: white; }
        .nav-left { left: -4px; }
        .nav-right { right: -4px; }

        /* Left page: list for the day */
        .entries-list {
            flex: 1; overflow-y: auto; padding-right: 4px;
        }
        .entry-item {
            padding: 14px; margin-bottom: 10px; background: rgba(255, 255, 255, 0.65);
            border-radius: 10px; cursor: pointer; transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .entry-item:hover { transform: translateY(-1px); }
        .entry-item.selected { outline: 2px solid rgba(123,97,255,0.3); background: rgba(123,97,255,0.06); }
        .entry-date { font-size: 11px; color: #777; margin-bottom: 6px; letter-spacing: 0.4px; }
        .entry-title { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 6px; }
        .entry-preview { font-size: 13px; color: #666; line-height: 1.4; }

        /* Right page: content */
        .entry-full-title { font-size: 22px; font-weight: 600; color: #333; margin-bottom: 10px; }
        .entry-full-date { font-size: 12px; color: #666; margin-bottom: 12px; letter-spacing: 0.4px; text-transform: uppercase; }
        .entry-full-mood { font-size: 22px; margin-bottom: 12px; }
        .entry-full-content { font-size: 15px; line-height: 1.7; color: #333; margin-bottom: 16px; white-space: pre-wrap; }
        .entry-photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .entry-photo-large { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(255,255,255,0.6); cursor: pointer; }

        /* Overlays: date picker & search */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.35); backdrop-filter: blur(6px);
            display: none; align-items: center; justify-content: center; z-index: 3000;
        }
        .overlay.active { display: flex; }
        .overlay-card {
            width: 92%; max-width: 520px; background: rgba(255,255,255,0.95); border: 1px solid rgba(255,255,255,0.6);
            border-radius: 16px; padding: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .overlay-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .overlay-title { font-size: 18px; font-weight: 500; }
        .overlay-close { border: none; background: rgba(0,0,0,0.04); width: 36px; height: 36px; border-radius: 10px; font-size: 18px; cursor: pointer; }
        .month-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .month-btn { padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.7); background: rgba(255,255,255,0.85); cursor: pointer; }
        .month-btn.active { background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); color: white; border-color: transparent; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-btn { padding: 10px 0; text-align: center; border-radius: 8px; border: 1px solid rgba(255,255,255,0.7); background: rgba(255,255,255,0.85); cursor: pointer; font-size: 13px; }
        .day-btn.today { outline: 2px solid rgba(123,97,255,0.3); }
        .day-btn.active { background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); color: white; border-color: transparent; }

        /* Search overlay */
        .search-input-big { width: 100%; padding: 14px 16px; font-size: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.7); background: rgba(255,255,255,0.9); margin-bottom: 10px; }
        .search-results { max-height: 50vh; overflow: auto; }
        .search-item { padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.6); background: rgba(255,255,255,0.85); margin-bottom: 8px; cursor: pointer; }

        /* Empty State */
        .empty-state {
            text-align: center; padding: 60px 20px; color: #666;
        }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-title { font-size: 18px; font-weight: 500; margin-bottom: 8px; }
        .empty-subtitle { font-size: 14px; }

        /* Floating Add Button */
        .floating-add-btn { 
            position: fixed; bottom: 30px; right: 30px; width: 64px; height: 64px; 
            border-radius: 50%; background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            border: none; color: white; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; font-size: 28px; transition: all 0.3s ease; 
            z-index: 1000; box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
        }
        .floating-add-btn:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(123, 97, 255, 0.4); }

        /* Enhanced Add Form Styles */
        .enhanced-add-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 6000;
            opacity: 0; transition: all 0.3s ease;
        }
        .enhanced-add-overlay.active { display: flex; opacity: 1; }
        .enhanced-add-content {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(60px);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 16px;
            padding: 20px; max-width: 800px; width: 98%; position: relative;
            transform: scale(0.9); transition: transform 0.3s ease;
            max-height: 85vh; overflow-y: auto;
        }
        .enhanced-add-overlay.active .enhanced-add-content { transform: scale(1); }
        .enhanced-add-header { 
            display: flex; justify-content: flex-end; align-items: center; 
            margin-bottom: 10px; padding-bottom: 5px; 
        }
        .enhanced-add-title {
            display: none; /* Hide title for 7" screen */
        }
        .enhanced-add-close {
            background: rgba(255, 255, 255, 0.8); border: none;
            border-radius: 50%; width: 32px; height: 32px;
            font-size: 16px; cursor: pointer; color: #666;
            position: absolute; top: 10px; right: 10px; z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Add Type Toggle */
        .add-type-toggle {
            display: flex; gap: 10px; margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.3); border-radius: 12px;
            padding: 4px; border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .toggle-btn {
            flex: 1; padding: 12px 20px; border: none; border-radius: 8px;
            background: transparent; color: #666; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.3s ease; min-height: 44px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .toggle-btn.active {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white; box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
        }
        .toggle-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5); color: #333;
        }
        .enhanced-add-layout {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            align-items: start;
        }
        .enhanced-form-section {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px; padding: 15px;
        }
        .enhanced-form-title {
            font-size: 16px; font-weight: 600; color: #333;
            margin-bottom: 15px; display: flex; align-items: center; gap: 6px;
        }
        .enhanced-form-field {
            margin-bottom: 15px;
        }
        .enhanced-form-label {
            display: block; font-size: 14px; font-weight: 500; color: #555;
            margin-bottom: 8px;
        }
        .enhanced-form-input {
            width: 100%; padding: 12px 16px; border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 10px; background: rgba(255, 255, 255, 0.8);
            font-size: 14px; color: #333; transition: all 0.3s ease;
        }
        .enhanced-form-input:focus {
            outline: none; border-color: #7B61FF;
            box-shadow: 0 0 0 3px rgba(123, 97, 255, 0.1);
        }
        .enhanced-form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .enhanced-form-checkbox {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 20px;
        }
        .enhanced-form-checkbox input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: #7B61FF;
        }
        .enhanced-form-checkbox label {
            font-size: 14px; color: #555; cursor: pointer;
        }
        .enhanced-form-actions {
            display: flex; gap: 12px; justify-content: flex-end;
            margin-top: 25px; padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        .enhanced-form-btn {
            padding: 12px 24px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease;
        }
        .enhanced-form-btn.primary {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white;
        }
        .enhanced-form-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
        }
        .enhanced-form-btn.secondary {
            background: rgba(255, 255, 255, 0.6);
            color: #666; border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .enhanced-form-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        /* AI Chat Section */
        .ai-chat-section {
            text-align: center; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .ai-chat-orb {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; cursor: pointer; margin-bottom: 20px;
            transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
            animation: pulse 2s infinite;
        }
        .ai-chat-orb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(123, 97, 255, 0.4);
            animation: none;
        }
        .ai-chat-text {
            font-size: 16px; font-weight: 500; color: #333;
            margin-bottom: 15px;
        }
        .voice-conversation {
            margin-top: 20px; padding: 15px; background: rgba(123, 97, 255, 0.05);
            border-radius: 8px; border: 1px solid rgba(123, 97, 255, 0.1);
        }
        .conversation-item {
            margin-bottom: 10px; padding: 8px 12px; border-radius: 6px;
            font-size: 14px; line-height: 1.4;
        }
        .conversation-item.user {
            background: rgba(123, 97, 255, 0.1); border-left: 3px solid #7B61FF;
        }
        .conversation-item.assistant {
            background: rgba(90, 224, 224, 0.1); border-left: 3px solid #5AE0E0;
        }
        .conversation-item strong {
            color: #333; margin-right: 8px;
        }
        
        /* Photo Upload Styles - Optimized for 7" screen */
        .photo-upload-area {
            border: 2px dashed #ddd; border-radius: 6px; padding: 10px;
            text-align: center; background: #fafafa; transition: all 0.3s ease;
        }
        .photo-upload-area:hover {
            border-color: #7B61FF; background: rgba(123, 97, 255, 0.05);
        }
        .photo-upload-placeholder {
            cursor: pointer; padding: 10px;
        }
        .photo-upload-icon {
            font-size: 20px; margin-bottom: 5px; color: #7B61FF;
        }
        .photo-upload-text {
            font-size: 12px; font-weight: 500; color: #333; margin-bottom: 3px;
        }
        .photo-upload-subtext {
            font-size: 10px; color: #666;
        }
        .photo-preview-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 6px; margin-top: 8px;
        }
        .photo-preview {
            position: relative; width: 50px; height: 50px;
            border-radius: 6px; overflow: hidden; border: 1px solid #ddd;
        }
        .photo-preview img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .photo-remove {
            position: absolute; top: -3px; right: -3px;
            width: 16px; height: 16px; border-radius: 50%;
            background: #ff4444; color: white; border: none;
            font-size: 10px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }
        
        /* Photo Layout Styles */
        .photo-layout-options {
            display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;
        }
        .layout-option {
            padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px;
            background: white; cursor: pointer; transition: all 0.3s ease;
            font-size: 12px; font-weight: 500; color: #666;
        }
        .layout-option.active {
            border-color: #7B61FF; background: rgba(123, 97, 255, 0.1);
            color: #7B61FF;
        }
        .layout-option:hover:not(.active) {
            border-color: #999; background: #f5f5f5;
        }
        
        /* Photo Layout Grids */
        .photo-grid-single { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .photo-grid-double { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .photo-grid-triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .photo-grid-masonry { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
        }
        .photo-grid-mosaic {
            display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr;
            gap: 8px; height: 200px;
        }
        .photo-grid-mosaic .photo-preview:first-child {
            grid-row: 1 / -1;
        }
        .voice-examples {
            background: rgba(123, 97, 255, 0.1);
            border-radius: 8px; padding: 15px; text-align: left;
        }
        .voice-examples p {
            margin: 5px 0; font-size: 12px; color: #666;
        }
        .voice-examples strong {
            color: #7B61FF;
        }
        
        @media (max-width: 768px) {
            .enhanced-add-layout { grid-template-columns: 1fr; gap: 20px; }
            .enhanced-add-content { padding: 20px; max-width: 95%; }
            .enhanced-form-row { grid-template-columns: 1fr; }
        }

        /* Voice Dictation Modal */
        .voice-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); display: flex;
            align-items: center; justify-content: center; z-index: 2000;
        }
        .voice-modal-content {
            background: white; border-radius: 16px; padding: 30px;
            max-width: 500px; width: 90%; text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .voice-modal-header {
            margin-bottom: 20px;
        }
        .voice-modal-title {
            font-size: 24px; font-weight: 600; color: #333;
            margin-bottom: 8px;
        }
        .voice-modal-subtitle {
            font-size: 14px; color: #666;
        }
        .voice-status {
            margin: 20px 0; padding: 20px;
            background: rgba(123, 97, 255, 0.1);
            border-radius: 12px; border: 2px solid rgba(123, 97, 255, 0.2);
        }
        .voice-status.listening {
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
        }
        .voice-status.processing {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }
        .voice-status.success {
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
        }
        .voice-icon {
            font-size: 48px; margin-bottom: 10px;
        }
        .voice-text {
            font-size: 16px; color: #333; margin-bottom: 10px;
            min-height: 20px;
        }
        .voice-transcript {
            font-size: 14px; color: #666; font-style: italic;
            min-height: 20px; max-height: 100px; overflow-y: auto;
        }
        .voice-controls {
            display: flex; gap: 12px; justify-content: center; margin-top: 20px;
        }
        .voice-btn {
            padding: 12px 24px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease;
        }
        .voice-btn.primary {
            background: #7B61FF; color: white;
        }
        .voice-btn.primary:hover {
            background: #6B4CE6;
        }
        .voice-btn.secondary {
            background: #f8f9fa; color: #666; border: 1px solid #dee2e6;
        }
        .voice-btn.secondary:hover {
            background: #e9ecef;
        }

        /* More Overlay */
        .more-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 3000;
            opacity: 0; transition: all 0.3s ease;
        }
        .more-overlay.active { display: flex; opacity: 1; }
        .more-content {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(60px);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 20px;
            padding: 40px; max-width: 500px; width: 90%; position: relative;
            transform: scale(0.8); transition: transform 0.3s ease;
        }
        .more-overlay.active .more-content { transform: scale(1); }
        .more-header { text-align: center; margin-bottom: 30px; }
        .more-title {
            font-size: 24px; font-weight: 300; color: #333; margin-bottom: 10px;
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .more-close {
            position: absolute; top: 15px; right: 15px; 
            background: rgba(255, 255, 255, 0.6); border: none;
            border-radius: 50%; width: 36px; height: 36px;
            font-size: 18px; cursor: pointer; color: #666;
        }
        .more-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .more-item {
            background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px; padding: 24px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; min-height: 120px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .more-item:hover {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white; transform: translateY(-4px);
        }
        .more-item-icon { font-size: 36px; margin-bottom: 12px; }
        .more-item-label { font-size: 15px; font-weight: 500; }

        /* Photo Modal */
        .photo-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.9); display: none; align-items: center;
            justify-content: center; z-index: 4000; opacity: 0; transition: all 0.3s ease;
        }
        .photo-modal.active { display: flex; opacity: 1; }
        .photo-modal-content {
            max-width: 90vw; max-height: 90vh; position: relative;
        }
        .photo-modal img {
            max-width: 100%; max-height: 100%; border-radius: 12px;
        }
        .photo-modal-close {
            position: absolute; top: -40px; right: 0; background: rgba(255, 255, 255, 0.2);
            border: none; border-radius: 50%; width: 40px; height: 40px;
            font-size: 20px; cursor: pointer; color: white;
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .nav-menu { display: none; }
            .book { max-width: 100%; grid-template-columns: 1fr; }
            .spine { display: none; }
            .nav-arrow { width: 52px; height: 52px; }
            .more-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-left">
            <div class="mini-orb" onclick="window.location.href='index.html'"></div>
            <div class="nav-menu">
                <a href="index.html" class="nav-item">Chat</a>
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="lists.html" class="nav-item">Lists</a>
                <a href="calendar.html" class="nav-item">Calendar</a>
                <a href="journal.html" class="nav-item active">Journal</a>
                <button class="more-nav-btn" onclick="openMoreOverlay()">More</button>
            </div>
        </div>
        <div class="nav-right">
            <div class="api-indicator connecting" id="apiStatus">Connecting</div>
            <button class="settings-btn" onclick="window.location.href='settings.html'" title="Settings">⚙️</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Top Info Bar -->
        <div class="top-info-bar">
            <div class="time-display">
                <div class="current-time" id="currentTime">Loading...</div>
                <div class="current-date" id="currentDate">Loading...</div>
            </div>
            <div class="weather-widget">
                <div>☀️</div>
                <div>23°</div>
            </div>
        </div>

        <!-- Journal Layout -->
        <div class="journal-layout">
            <button class="nav-arrow nav-left" onclick="navigateDay(-1)">⟵</button>
            <div class="book" id="book">
                <div class="page" id="leftPage">
                    <div class="page-header">
                        <button class="date-header" id="dateHeaderLeft" onclick="openDatePicker()">Today</button>
                        <button class="date-header" onclick="openSearchOverlay()">🔍 Search</button>
                    </div>
                    <div class="entries-list" id="entriesList"></div>
                </div>
                <div class="spine"></div>
                <div class="page" id="rightPage">
                    <div class="page-header">
                        <div class="date-header" id="dateHeaderRight" onclick="openDatePicker()">Today</div>
                        <div></div>
                    </div>
                    <div class="entry-content" id="entryContent">
                        <div class="empty-state">
                            <div class="empty-icon">📖</div>
                            <div class="empty-title">Your journal</div>
                            <div class="empty-subtitle">Choose an entry on the left to read</div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="nav-arrow nav-right" onclick="navigateDay(1)">⟶</button>
        </div>
    </div>

    <!-- More Overlay -->
    <div class="more-overlay" id="moreOverlay">
        <div class="more-content">
            <button class="more-close" onclick="closeMoreOverlay()">×</button>
            <div class="more-header">
                <h2 class="more-title">More Options</h2>
            </div>
            <div class="more-grid">
                <div class="more-item" onclick="navigateToPage('memories.html')">
                    <div class="more-item-icon">🧠</div>
                    <div class="more-item-label">Memories</div>
                </div>
                <div class="more-item" onclick="navigateToPage('workflows.html')">
                    <div class="more-item-icon">⚡</div>
                    <div class="more-item-label">Workflows</div>
                </div>
                <div class="more-item" onclick="navigateToPage('settings.html')">
                    <div class="more-item-icon">⚙️</div>
                    <div class="more-item-label">Settings</div>
                </div>
                <div class="more-item" onclick="alert('Coming soon!')">
                    <div class="more-item-icon">📊</div>
                    <div class="more-item-label">Analytics</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="photo-modal" id="photoModal">
        <div class="photo-modal-content">
            <button class="photo-modal-close" onclick="closePhotoModal()">×</button>
            <img id="modalPhoto" src="" alt="Journal photo">
        </div>
    </div>

    <!-- Date Picker Overlay -->
    <div class="overlay" id="dateOverlay">
        <div class="overlay-card">
            <div class="overlay-header">
                <button class="overlay-close" onclick="closeDatePicker()">×</button>
                <div class="overlay-title" id="overlayTitle">Pick a date</div>
                <div style="display:flex; gap:8px;">
                    <button class="overlay-close" onclick="changeYear(-1)">−</button>
                    <button class="overlay-close" onclick="changeYear(1)">+</button>
                </div>
            </div>
            <div class="month-row" id="monthRow"></div>
            <div class="days-grid" id="daysGrid"></div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="overlay" id="searchOverlay">
        <div class="overlay-card">
            <div class="overlay-header">
                <div class="overlay-title">Search entries</div>
                <button class="overlay-close" onclick="closeSearchOverlay()">×</button>
            </div>
            <input id="searchBig" class="search-input-big" placeholder="Search by title or content" />
            <div id="searchResults" class="search-results"></div>
        </div>
    </div>

    <!-- Enhanced Add Entry Form -->
    <div class="enhanced-add-overlay" id="enhancedAddOverlay">
        <div class="enhanced-add-content">
            <div class="enhanced-add-header">
                <h3 class="enhanced-add-title">New Journal Entry</h3>
                <button class="enhanced-add-close" onclick="closeEnhancedAddForm()">×</button>
            </div>
            
            <div class="enhanced-add-layout">
                <!-- Manual Form Section -->
                <div class="enhanced-form-section">
                    <!-- Toggle between Entry and Memory -->
                    <div class="add-type-toggle">
                        <button class="toggle-btn active" id="toggleEntry" onclick="toggleAddType('entry')">📝 Entry</button>
                        <button class="toggle-btn" id="toggleMemory" onclick="toggleAddType('memory')">🧠 Memory</button>
                    </div>
                    <h4 class="enhanced-form-title">📝 Entry Details</h4>
                    <div class="enhanced-form-field">
                        <label class="enhanced-form-label">Entry Title</label>
                        <input type="text" class="enhanced-form-input" id="enhancedEntryTitle" placeholder="Enter entry title">
                    </div>
                    <div class="enhanced-form-field">
                        <label class="enhanced-form-label">Entry Content</label>
                        <textarea class="enhanced-form-input" id="enhancedEntryContent" rows="6" placeholder="Write your thoughts, experiences, or reflections..."></textarea>
                    </div>
                    <div class="enhanced-form-row">
                        <div class="enhanced-form-field">
                            <label class="enhanced-form-label">Mood</label>
                            <select class="enhanced-form-input" id="enhancedEntryMood">
                                <option value="">Select mood...</option>
                                <option value="happy">😊 Happy</option>
                                <option value="sad">😢 Sad</option>
                                <option value="excited">🤩 Excited</option>
                                <option value="anxious">😰 Anxious</option>
                                <option value="calm">😌 Calm</option>
                                <option value="grateful">🙏 Grateful</option>
                                <option value="frustrated">😤 Frustrated</option>
                                <option value="content">😌 Content</option>
                            </select>
                        </div>
                        <div class="enhanced-form-field">
                            <label class="enhanced-form-label">Category</label>
                            <select class="enhanced-form-input" id="enhancedEntryCategory">
                                <option value="general">General</option>
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="health">Health</option>
                                <option value="relationships">Relationships</option>
                                <option value="goals">Goals</option>
                                <option value="reflection">Reflection</option>
                            </select>
                        </div>
                    </div>
                    <div class="enhanced-form-checkbox">
                        <input type="checkbox" id="enhancedEntryPrivate">
                        <label for="enhancedEntryPrivate">Private entry (not shared)</label>
                    </div>
                    <div class="enhanced-form-field">
                        <label class="enhanced-form-label">Photos (Optional)</label>
                        <div class="photo-upload-area" id="photoUploadArea">
                            <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                            <div class="photo-upload-placeholder" onclick="document.getElementById('photoInput').click()">
                                <div class="photo-upload-icon">📷</div>
                                <div class="photo-upload-text">Tap to add photos</div>
                                <div class="photo-upload-subtext">Multiple photos supported</div>
                            </div>
                            <div class="photo-preview-container" id="photoPreviewContainer"></div>
                            <div class="photo-layout-options" id="photoLayoutOptions" style="display: none;">
                                <div class="layout-option active" onclick="selectPhotoLayout('single')">Single</div>
                                <div class="layout-option" onclick="selectPhotoLayout('double')">Double</div>
                                <div class="layout-option" onclick="selectPhotoLayout('triple')">Triple</div>
                                <div class="layout-option" onclick="selectPhotoLayout('masonry')">Masonry</div>
                                <div class="layout-option" onclick="selectPhotoLayout('mosaic')">Mosaic</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Voice Assistant Section -->
                <div class="enhanced-form-section ai-chat-section">
                    <h4 class="enhanced-form-title">🎤 Voice Dictation</h4>
                    <div class="ai-chat-orb" onclick="toggleVoiceInput()">
                        🎤
                    </div>
                    <div class="ai-chat-text">
                        Press to talk
                    </div>
                    <div class="voice-conversation" id="voiceConversation" style="display: none;">
                        <div class="conversation-item user" id="userMessage" style="display: none;">
                            <strong>You:</strong> <span id="userText"></span>
                        </div>
                        <div class="conversation-item assistant" id="assistantMessage" style="display: none;">
                            <strong>Zoe:</strong> <span id="assistantText"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="enhanced-form-actions">
                <button class="enhanced-form-btn secondary" onclick="closeEnhancedAddForm()">Cancel</button>
                <button class="enhanced-form-btn primary" onclick="saveEnhancedEntry()">Create Entry</button>
            </div>
        </div>
    </div>


    <!-- Floating Add Button -->
    <button class="floating-add-btn" onclick="openEnhancedAddForm()" title="New Entry">+</button>

    <script src="js/common.js"></script>
    <script src="js/ai-processor.js"></script>
    <script>
        let allEntries = [];
        
        // Update API status
        async function updateAPIStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const indicator = document.getElementById('apiStatus');
                if (response.ok) {
                    indicator.textContent = 'Online';
                    indicator.className = 'api-indicator online';
                } else {
                    indicator.textContent = 'Warning';
                    indicator.className = 'api-indicator warning';
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Offline';
                document.getElementById('apiStatus').className = 'api-indicator offline';
            }
        }
        let currentEntry = null;
        let currentDate = new Date();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEntries();
            updateDateHeaders();
            updateTime();
            setInterval(updateTime, 1000);
            updateAPIStatus();
            setInterval(updateAPIStatus, 30000); // Check every 30s

            // Swipe gestures for day navigation
            addSwipeListeners(document.getElementById('book'));
            
            // Handle routed data from other pages
            handleRoutedData();

            // Search overlay handlers
            document.getElementById('searchBig').addEventListener('input', onSearchInput);
        });

        // Load journal entries
        async function loadEntries() {
            try {
                const response = await apiRequest('/journal');
                allEntries = response.entries || [];
                renderDay(currentDate);
            } catch (error) {
                console.error('Failed to load entries:', error);
                allEntries = [];
                renderDay(currentDate);
            }
        }

        // Check if two dates are the same day
        function isSameDate(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        function renderDay(dateObj) {
            // Update headers
            updateDateHeaders();
            // Filter entries for the date
            const entriesForDate = allEntries
                .filter(entry => isSameDate(new Date(entry.created_at), dateObj))
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const listContainer = document.getElementById('entriesList');
            if (entriesForDate.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <div class="empty-title">No entries for this day</div>
                        <div class="empty-subtitle">Tap + to add your first note today</div>
                    </div>
                `;
                // Clear right page if no selection
                if (!currentEntry || !isSameDate(new Date(currentEntry.created_at), dateObj)) {
                    document.getElementById('entryContent').innerHTML = `
                        <div class=\"empty-state\">\n                            <div class=\"empty-icon\">📖</div>\n                            <div class=\"empty-title\">Your journal</div>\n                            <div class=\"empty-subtitle\">Choose an entry on the left to read</div>\n                        </div>
                    `;
                }
                return;
            }
            listContainer.innerHTML = entriesForDate.map(entry => `
                <div class="entry-item" onclick="selectEntry(${entry.id})">
                    <div class="entry-date">${formatTime(entry.created_at)}</div>
                    <div class="entry-title">${escapeHtml(entry.title)}</div>
                    <div class="entry-preview">${escapeHtml(entry.content.substring(0, 120))}${entry.content.length > 120 ? '...' : ''}</div>
                </div>
            `).join('');

            // If there is a currentEntry for this day, show it; else show the first
            if (!currentEntry || !isSameDate(new Date(currentEntry.created_at), dateObj)) {
                currentEntry = entriesForDate[0];
            }
            displayEntryContent(currentEntry);
        }

        function updateDateHeaders() {
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const text = currentDate.toLocaleDateString('en-US', options);
            document.getElementById('dateHeaderLeft').textContent = text;
            document.getElementById('dateHeaderRight').textContent = text;
        }

        function navigateDay(delta) {
            const next = new Date(currentDate);
            next.setDate(next.getDate() + delta);
            currentDate = next;
            currentEntry = null;
            renderDay(currentDate);
        }

        // Select entry
        function selectEntry(entryId) {
            const entry = allEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            currentEntry = entry;
            
            // Update UI
            document.querySelectorAll('.entry-item').forEach(item => {
                item.classList.remove('selected');
            });
            if (event && event.target) {
                const container = event.target.closest('.entry-item');
                if (container) container.classList.add('selected');
            }
            
            // Display entry content
            displayEntryContent(entry);
        }

        // Display entry content
        function displayEntryContent(entry) {
            const contentContainer = document.getElementById('entryContent');
            const contentTitle = document.getElementById('contentTitle');
            
            contentTitle.textContent = entry.title;
            
            contentContainer.innerHTML = `
                <div class="entry-full-title">${entry.title}</div>
                <div class="entry-full-date">${formatDate(entry.created_at)}</div>
                ${entry.mood ? `<div class="entry-full-mood">${entry.mood}</div>` : ''}
                <div class="entry-full-content">${entry.content}</div>
                ${entry.photos && entry.photos.length > 0 ? `
                    <div class="entry-photos-grid">
                        ${entry.photos.map(photo => 
                            `<img src="${photo.url}" class="entry-photo-large" alt="Journal photo" onclick="openPhotoModal('${photo.url}')">`
                        ).join('')}
                    </div>
                ` : ''}
                <div class="entry-actions">
                    <button class="action-btn secondary" onclick="editEntry(${entry.id})">Edit</button>
                    <button class="action-btn danger" onclick="deleteEntry(${entry.id})">Delete</button>
                </div>
            `;
        }

        // Open photo modal
        function openPhotoModal(photoUrl) {
            const modal = document.getElementById('photoModal');
            const modalPhoto = document.getElementById('modalPhoto');
            modalPhoto.src = photoUrl;
            modal.classList.add('active');
        }

        // Close photo modal
        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
        }

        // Create new entry
        function createNewEntry() {
            // Redirect to a new entry creation page or open modal
            window.location.href = 'journal-edit.html?mode=create';
        }

        // Enhanced Add Form Functions
        function openEnhancedAddForm() {
            const overlay = document.getElementById('enhancedAddOverlay');
            if (overlay) {
                overlay.classList.add('active');
                // Focus on the first input
                setTimeout(() => {
                    const firstInput = document.getElementById('enhancedEntryTitle');
                    if (firstInput) firstInput.focus();
                }, 300);
            }
        }

        function closeEnhancedAddForm() {
            const overlay = document.getElementById('enhancedAddOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                // Clear form
                clearEnhancedForm();
            }
        }

        // Toggle between Entry and Memory forms
        function toggleAddType(type) {
            const toggleEntry = document.getElementById('toggleEntry');
            const toggleMemory = document.getElementById('toggleMemory');
            const title = document.querySelector('.enhanced-add-title');
            const formTitle = document.querySelector('.enhanced-form-title');
            
            if (type === 'entry') {
                toggleEntry.classList.add('active');
                toggleMemory.classList.remove('active');
                title.textContent = 'New Journal Entry';
                formTitle.textContent = '📝 Entry Details';
            } else {
                toggleEntry.classList.remove('active');
                toggleMemory.classList.add('active');
                title.textContent = 'New Memory';
                formTitle.textContent = '🧠 Memory Details';
            }
        }

        function clearEnhancedForm() {
            document.getElementById('enhancedEntryTitle').value = '';
            document.getElementById('enhancedEntryContent').value = '';
            document.getElementById('enhancedEntryMood').value = '';
            document.getElementById('enhancedEntryCategory').value = 'general';
            document.getElementById('enhancedEntryPrivate').checked = false;
            // Clear photos
            document.getElementById('photoPreviewContainer').innerHTML = '';
            document.getElementById('photoInput').value = '';
            uploadedPhotos = [];
            currentPhotoLayout = 'single';
            updatePhotoLayout();
        }

        // Photo handling functions
        let uploadedPhotos = [];
        let currentPhotoLayout = 'single';
        
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoData = {
                            id: Date.now() + Math.random(),
                            file: file,
                            dataUrl: e.target.result
                        };
                        uploadedPhotos.push(photoData);
                        displayPhotoPreview(photoData);
                        updatePhotoLayout();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function displayPhotoPreview(photoData) {
            const container = document.getElementById('photoPreviewContainer');
            const preview = document.createElement('div');
            preview.className = 'photo-preview';
            preview.innerHTML = `
                <img src="${photoData.dataUrl}" alt="Preview">
                <button class="photo-remove" onclick="removePhoto('${photoData.id}')">×</button>
            `;
            container.appendChild(preview);
        }
        
        function removePhoto(photoId) {
            uploadedPhotos = uploadedPhotos.filter(photo => photo.id !== photoId);
            const container = document.getElementById('photoPreviewContainer');
            const previews = container.querySelectorAll('.photo-preview');
            previews.forEach(preview => {
                if (preview.querySelector('.photo-remove').onclick.toString().includes(photoId)) {
                    preview.remove();
                }
            });
            updatePhotoLayout();
        }
        
        function selectPhotoLayout(layout) {
            currentPhotoLayout = layout;
            const options = document.querySelectorAll('.layout-option');
            options.forEach(option => option.classList.remove('active'));
            event.target.classList.add('active');
            updatePhotoLayout();
        }
        
        function updatePhotoLayout() {
            const container = document.getElementById('photoPreviewContainer');
            const layoutOptions = document.getElementById('photoLayoutOptions');
            
            // Show layout options if there are photos
            if (uploadedPhotos.length > 0) {
                layoutOptions.style.display = 'flex';
            } else {
                layoutOptions.style.display = 'none';
            }
            
            // Apply layout class
            container.className = `photo-preview-container photo-grid-${currentPhotoLayout}`;
        }

        function saveEnhancedEntry() {
            const title = document.getElementById('enhancedEntryTitle').value.trim();
            const content = document.getElementById('enhancedEntryContent').value.trim();
            const mood = document.getElementById('enhancedEntryMood').value;
            const category = document.getElementById('enhancedEntryCategory').value;
            const isPrivate = document.getElementById('enhancedEntryPrivate').checked;

            if (!title || !content) {
                alert('Please enter both title and content');
                return;
            }

            // Create new entry
            const newEntry = {
                id: Date.now().toString(),
                title: title,
                content: content,
                mood: mood,
                category: category,
                isPrivate: isPrivate,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };

            // Add to entries array
            allEntries.unshift(newEntry);
            
            // Save to localStorage
            localStorage.setItem('journalEntries', JSON.stringify(allEntries));
            
            // Refresh display
            renderEntries();
            
            // Close form
            closeEnhancedAddForm();
            
            // Show success message
            showNotification(`Created journal entry: "${title}"`, 'success');
        }

        // Voice Dictation Functions
        let recognition = null;
        let isListening = false;
        let currentTranscript = '';

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                console.log('Speech recognition not supported');
                return false;
            }

            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                showConversation();
                showUserMessage('Listening...');
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        currentTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                if (interimTranscript) {
                    showUserMessage(interimTranscript);
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                
                let errorMessage = 'Sorry, I had trouble hearing you. ';
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = 'Microphone access denied. Please allow microphone access and try again.';
                        break;
                    case 'no-speech':
                        errorMessage = 'I didn\'t hear anything. Please try again.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'No microphone found. Please check your microphone.';
                        break;
                    case 'network':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                    default:
                        errorMessage = 'Something went wrong. Please try again.';
                }
                
                showAssistantMessage(errorMessage);
                
                // Show grant permission button for not-allowed errors
                if (event.error === 'not-allowed') {
                    const grantBtn = document.getElementById('grantPermissionBtn');
                    if (grantBtn) grantBtn.style.display = 'inline-block';
                }
                
                // Reset button
                const startBtn = document.getElementById('startListeningBtn');
                if (startBtn) {
                    startBtn.textContent = 'Start Listening';
                    startBtn.onclick = startListening;
                }
            };

            recognition.onend = function() {
                isListening = false;
                if (currentTranscript.trim()) {
                    processVoiceCommand(currentTranscript);
                } else {
                    showAssistantMessage('I didn\'t hear anything. Please try again.');
                }
                
                // Reset button
                const startBtn = document.getElementById('startListeningBtn');
                if (startBtn) {
                    startBtn.textContent = 'Start Listening';
                    startBtn.onclick = startListening;
                }
            };

            return true;
        }

        async function startVoiceInput() {
            console.log('🎤 Voice input started');
            
            // Check if getUserMedia is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAssistantMessage('Voice input is not available. Please use HTTPS or a modern browser.');
                return;
            }
            
            // Request microphone permission
            try {
                console.log('🎤 Requesting microphone permission...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('🎤 Permission granted!');
                
                // Permission granted, stop the stream
                stream.getTracks().forEach(track => track.stop());
                
                // Initialize speech recognition
                if (!initVoiceRecognition()) {
                    showAssistantMessage('Speech recognition is not supported in this browser.');
                    return;
                }
                
                currentTranscript = '';
                recognition.start();
                
            } catch (error) {
                console.error('🎤 Microphone permission denied:', error);
                showAssistantMessage('Microphone access denied. Please allow microphone access and try again.');
            }
        }

        function toggleVoiceInput() {
            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
            }
            isListening = false;
            currentTranscript = '';
        }

        // Route to other pages with data
        function routeToPage(page, action, formData) {
            if (page === 'lists') {
                window.location.href = `lists.html?action=${action}&data=${encodeURIComponent(JSON.stringify(formData))}`;
            } else if (page === 'calendar') {
                window.location.href = `calendar.html?action=${action}&data=${encodeURIComponent(JSON.stringify(formData))}`;
            } else {
                showAssistantMessage(`I understand you want to add something to ${page}, but I'm not sure how to handle that from here.`);
            }
        }

        // Handle routed data from URL parameters
        function handleRoutedData() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const data = urlParams.get('data');
            
            if (action && data) {
                try {
                    const formData = JSON.parse(decodeURIComponent(data));
                    
                    // Open the enhanced form
                    openEnhancedAddForm();
                    
                    // Populate based on action
                    if (action === 'addEntry') {
                        document.getElementById('enhancedEntryTitle').value = formData.title;
                        document.getElementById('enhancedEntryContent').value = formData.content;
                        document.getElementById('enhancedEntryMood').value = formData.mood;
                        document.getElementById('enhancedEntryCategory').value = formData.category;
                    }
                    
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Error handling routed data:', error);
                }
            }
        }

        async function startListening() {
            if (!recognition) return;
            
            // Request microphone permission first
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Permission granted, stop the stream and start recognition
                stream.getTracks().forEach(track => track.stop());
                
                currentTranscript = '';
                recognition.start();
                document.getElementById('startListeningBtn').textContent = 'Stop Listening';
                document.getElementById('startListeningBtn').onclick = stopListening;
                
                // Hide grant permission button if it was shown
                const grantBtn = document.getElementById('grantPermissionBtn');
                if (grantBtn) grantBtn.style.display = 'none';
            } catch (error) {
                console.error('Microphone permission denied:', error);
                updateVoiceStatus('error', '❌ Permission Denied', 'Microphone access is required for voice input.');
                
                // Show grant permission button
                const grantBtn = document.getElementById('grantPermissionBtn');
                if (grantBtn) grantBtn.style.display = 'inline-block';
            }
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                updateVoiceStatus('idle', '🎤 Ready', 'Permission granted! Click "Start Listening" to begin.');
                
                // Hide grant permission button
                const grantBtn = document.getElementById('grantPermissionBtn');
                if (grantBtn) grantBtn.style.display = 'none';
            } catch (error) {
                console.error('Microphone permission still denied:', error);
                updateVoiceStatus('error', '❌ Still Denied', 'Please check your browser settings and allow microphone access for this site.');
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
        }

        function updateVoiceStatus(status, icon, text) {
            const statusEl = document.getElementById('voiceStatus');
            const textEl = document.getElementById('voiceText');
            const iconEl = document.querySelector('.voice-icon');
            
            if (statusEl) {
                statusEl.className = `voice-status ${status}`;
            }
            if (textEl) {
                textEl.textContent = text;
            }
            if (iconEl) {
                iconEl.textContent = icon;
            }
        }

        // Voice conversation functions
        function showUserMessage(text) {
            const userMessage = document.getElementById('userMessage');
            const userText = document.getElementById('userText');
            if (userMessage && userText) {
                userText.textContent = text;
                userMessage.style.display = 'block';
            }
        }

        function showAssistantMessage(text) {
            const assistantMessage = document.getElementById('assistantMessage');
            const assistantText = document.getElementById('assistantText');
            if (assistantMessage && assistantText) {
                assistantText.textContent = text;
                assistantMessage.style.display = 'block';
            }
        }

        function showConversation() {
            const conversation = document.getElementById('voiceConversation');
            if (conversation) {
                conversation.style.display = 'block';
            }
        }

        // AI-powered command processing for journal
        function processWithAI(command) {
            const patterns = {
                // Title extraction patterns
                title: {
                    timeBased: /^(today|this morning|this afternoon|this evening|yesterday|last night|this week|this month)/i,
                    feelingBased: /^(i feel|i'm feeling|i am feeling|i think|i believe|i realize|i learned|i discovered)/i,
                    actionBased: /^(work|meeting|appointment|event|happened|occurred|went to|visited|saw|met)/i
                },
                // Mood detection patterns
                mood: {
                    happy: /(?:happy|joy|excited|great|wonderful|amazing|fantastic|brilliant|awesome|delighted|thrilled|ecstatic)/i,
                    sad: /(?:sad|down|depressed|upset|disappointed|hurt|broken|devastated|miserable|gloomy|melancholy)/i,
                    grateful: /(?:grateful|thankful|blessed|appreciate|gratitude|fortunate|lucky)/i,
                    anxious: /(?:anxious|worried|nervous|stressed|concerned|uneasy|troubled|fearful|apprehensive)/i,
                    calm: /(?:calm|peaceful|relaxed|serene|content|tranquil|zen|meditative|centered)/i,
                    frustrated: /(?:frustrated|annoyed|irritated|angry|mad|furious|livid|exasperated)/i,
                    excited: /(?:excited|thrilled|pumped|energized|enthusiastic|eager|anticipating)/i
                },
                // Category detection patterns
                category: {
                    work: /(?:work|job|office|meeting|project|task|deadline|business|conference|presentation)/i,
                    health: /(?:health|exercise|doctor|medical|fitness|wellness|appointment|checkup|dentist)/i,
                    relationships: /(?:family|relationship|partner|spouse|children|kids|friends|social|date)/i,
                    goals: /(?:goal|plan|future|dream|aspiration|ambition|resolution|target|objective)/i,
                    reflection: /(?:reflect|think|contemplate|meditate|ponder|consider|analyze|evaluate)/i,
                    personal: /(?:travel|trip|vacation|journey|adventure|hobby|interest|passion|creative)/i
                }
            };

            let result = {
                title: '',
                content: command,
                mood: '',
                category: 'general',
                confidence: 0
            };

            // Extract title
            for (let [type, pattern] of Object.entries(patterns.title)) {
                const match = command.match(pattern);
                if (match) {
                    result.title = match[0];
                    result.confidence = 0.8;
                    break;
                }
            }

            // If no title pattern found, use first few words
            if (!result.title) {
                const words = command.split(' ');
                result.title = words.length > 6 ? words.slice(0, 6).join(' ') + '...' : command;
                result.confidence = 0.5;
            }

            // Detect mood
            for (let [moodType, pattern] of Object.entries(patterns.mood)) {
                if (pattern.test(command)) {
                    result.mood = moodType;
                    break;
                }
            }

            // Detect category
            for (let [categoryType, pattern] of Object.entries(patterns.category)) {
                if (pattern.test(command)) {
                    result.category = categoryType;
                    break;
                }
            }

            return result;
        }

        function updateVoiceText(text) {
            const transcriptEl = document.getElementById('voiceTranscript');
            if (transcriptEl) {
                transcriptEl.textContent = text;
            }
        }

        function processVoiceCommand(transcript) {
            showAssistantMessage('Processing...');
            showUserMessage(transcript);
            
            // Use unified AI processing
            const result = window.zoeAI.processInput(transcript, { page: 'journal' });
            
            // Show the AI's response
            if (result.response) {
                showAssistantMessage(result.response);
            }
            
            if (result.routing.page === 'journal') {
                // Populate form fields with AI results
                document.getElementById('enhancedEntryTitle').value = result.routing.formData.title;
                document.getElementById('enhancedEntryContent').value = result.routing.formData.content;
                document.getElementById('enhancedEntryMood').value = result.routing.formData.mood;
                document.getElementById('enhancedEntryCategory').value = result.routing.formData.category;
            } else if (result.routing.page === 'conversation') {
                // Handle conversational responses
                if (result.intent === 'greeting' || result.intent === 'question') {
                    // Just show the response, no form population needed
                }
            } else if (result.routing.page === 'memory') {
                // Memory saved, just show confirmation
            } else {
                // Route to other pages
                routeToPage(result.routing.page, result.routing.action, result.routing.formData);
            }
            
            // Hide voice controls after success
            setTimeout(() => {
                stopVoiceInput();
            }, 2000);
        }

        // Edit entry
        function editEntry(entryId) {
            window.location.href = `journal-edit.html?mode=edit&id=${entryId}`;
        }

        // Delete entry
        async function deleteEntry(entryId) {
            if (!confirm('Delete this entry?')) return;
            
            try {
                await apiRequest(`/journal/${entryId}`, {
                    method: 'DELETE'
                });
                
                allEntries = allEntries.filter(e => e.id !== entryId);
                renderDay(currentDate);
                
                // Clear content if deleted entry was selected
                if (currentEntry && currentEntry.id === entryId) {
                    document.getElementById('contentTitle').textContent = 'Select an Entry';
                    document.getElementById('entryContent').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📝</div>
                            <div class="empty-title">No entry selected</div>
                            <div class="empty-subtitle">Choose an entry from the list to view its content</div>
                        </div>
                    `;
                    currentEntry = null;
                }
                
                showNotification('Entry deleted', 'success');
            } catch (error) {
                console.error('Failed to delete entry:', error);
                showNotification('Failed to delete entry', 'error');
            }
        }

        // Search overlay
        function openSearchOverlay() {
            document.getElementById('searchOverlay').classList.add('active');
            document.getElementById('searchBig').focus();
        }
        function closeSearchOverlay() {
            document.getElementById('searchOverlay').classList.remove('active');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchBig').value = '';
        }
        function onSearchInput(e) {
            const q = e.target.value.toLowerCase();
            const results = document.getElementById('searchResults');
            if (!q) { results.innerHTML = ''; return; }
            const filtered = allEntries.filter(en => en.title.toLowerCase().includes(q) || en.content.toLowerCase().includes(q));
            if (filtered.length === 0) { results.innerHTML = '<div class="empty-state"><div class="empty-title">No results</div></div>'; return; }
            results.innerHTML = filtered.slice(0, 50).map(en => `
                <div class="search-item" onclick="jumpToEntry(${en.id})">
                    <div style="font-weight:600; font-size:14px;">${escapeHtml(en.title)}</div>
                    <div style="font-size:12px; color:#666;">${formatDate(en.created_at)}</div>
                </div>
            `).join('');
        }
        function jumpToEntry(id) {
            const en = allEntries.find(e => e.id === id);
            if (!en) return;
            currentDate = new Date(en.created_at);
            renderDay(currentDate);
            selectEntry(id);
            closeSearchOverlay();
        }

        // Date picker overlay
        function openDatePicker() {
            buildMonthRow();
            buildDaysGrid();
            document.getElementById('dateOverlay').classList.add('active');
        }
        function closeDatePicker() {
            document.getElementById('dateOverlay').classList.remove('active');
        }
        function changeYear(delta) {
            currentDate.setFullYear(currentDate.getFullYear() + delta);
            buildMonthRow();
            buildDaysGrid();
            updateDateHeaders();
        }
        function buildMonthRow() {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const mRow = document.getElementById('monthRow');
            const y = currentDate.getFullYear();
            document.getElementById('overlayTitle').textContent = `Select date — ${y}`;
            mRow.innerHTML = months.map((m,i)=>`<button class="month-btn ${i===currentDate.getMonth()?'active':''}" onclick="selectMonth(${i})">${m}</button>`).join('');
        }
        function buildDaysGrid() {
            const daysGrid = document.getElementById('daysGrid');
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const today = new Date();
            let html = '';
            for (let d=1; d<=daysInMonth; d++) {
                const isToday = isSameDate(new Date(y,m,d), today);
                const isActive = d === currentDate.getDate();
                html += `<button class="day-btn ${isToday?'today':''} ${isActive?'active':''}" onclick="selectDay(${d})">${d}</button>`;
            }
            daysGrid.innerHTML = html;
        }
        function selectMonth(m) {
            currentDate.setMonth(m);
            buildMonthRow();
            buildDaysGrid();
        }
        function selectDay(d) {
            currentDate.setDate(d);
            closeDatePicker();
            currentEntry = null;
            renderDay(currentDate);
        }

        // Swipe detectors
        function addSwipeListeners(el) {
            let startX = 0, startY = 0, startTime = 0;
            el.addEventListener('touchstart', (e) => {
                const t = e.touches[0]; startX = t.clientX; startY = t.clientY; startTime = Date.now();
            }, { passive: true });
            el.addEventListener('touchend', (e) => {
                const t = e.changedTouches[0];
                const dx = t.clientX - startX; const dy = t.clientY - startY; const dt = Date.now() - startTime;
                if (dt < 500 && Math.abs(dx) > 50 && Math.abs(dy) < 40) {
                    if (dx < 0) navigateDay(1); else navigateDay(-1);
                }
            }, { passive: true });
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
            });
        }
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        function escapeHtml(str) {
            return String(str).replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        function navigateToPage(page) {
            window.location.href = page;
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('more-overlay')) {
                closeMoreOverlay();
            }
            if (e.target.classList.contains('photo-modal')) {
                closePhotoModal();
            }
            if (e.target.id === 'dateOverlay') {
                closeDatePicker();
            }
            if (e.target.id === 'searchOverlay') {
                closeSearchOverlay();
            }
        });
    </script>
</body>
</html>