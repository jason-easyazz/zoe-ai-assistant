<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Zoe - Lists</title>
    <link rel="stylesheet" href="css/glass.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: linear-gradient(135deg, #fafbfc 0%, #f1f3f6 100%);
            min-height: 100vh;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            color: #333;
            font-size: clamp(14px, 1.6vw, 16px);
        }

        /* Navigation - match dashboard/calendar */
        .nav-bar {
            position: fixed; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px; z-index: 100; display: flex; justify-content: space-between;
            align-items: center; height: 60px;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .mini-orb { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            cursor: pointer; transition: all 0.3s ease; min-width: 44px; min-height: 44px;
        }
        .mini-orb:hover { transform: scale(1.1); }
        .nav-menu { display: flex; gap: 20px; }
        .nav-item { 
            color: #666; text-decoration: none; font-size: 13px; font-weight: 400; 
            transition: all 0.3s ease; padding: 8px 12px; border-radius: 6px;
            min-height: 44px; display: flex; align-items: center;
        }
        .nav-item:hover, .nav-item.active { color: #7B61FF; background: rgba(123, 97, 255, 0.1); }
        .nav-right { display: flex; align-items: center; gap: 10px; }
        
        .more-nav-btn { 
            color: #666; text-decoration: none; font-size: 13px; font-weight: 400; 
            transition: all 0.3s ease; padding: 8px 12px; border-radius: 6px;
            min-height: 44px; display: flex; align-items: center; cursor: pointer;
            background: none; border: none;
        }
        .more-nav-btn:hover { color: #7B61FF; background: rgba(123, 97, 255, 0.1); }
        
        .settings-btn { 
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: all 0.3s ease; color: #666;
            font-size: 16px; font-weight: bold;
        }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.8); color: #333; }
        
        .api-indicator { font-size: 12px; padding: 4px 8px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .api-indicator.online { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .api-indicator.offline { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .api-indicator.warning { background: rgba(251, 146, 60, 0.1); color: #ea580c; }
        .api-indicator::before { content: ''; width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .api-indicator.online::before { background: #22c55e; }
        .api-indicator.offline::before { background: #ef4444; }
        .api-indicator.warning::before { background: #ea580c; }

        /* Main Layout */
        .main-container { padding: 70px 20px 20px; }
        .top-info-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding: 0 10px;
        }
        .time-display { display: flex; flex-direction: column; }
        .current-time { font-size: 18px; font-weight: 300; color: #333; }
        .current-date { font-size: 11px; color: #666; margin-top: 2px; }
        .weather-widget { display: flex; align-items: center; gap: 6px; }

        /* List Categories */
        .list-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 100px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .list-category {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(40px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        /* Category Header */
        .category-header {
            padding: 25px 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .category-title {
            font-size: clamp(16px, 2vw, 18px);
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }


        /* List Items */
        .list-items {
            padding: 12px 20px 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:active {
            transform: translateX(2px);
            background: rgba(255, 255, 255, 0.3);
            margin: 0 -15px;
            padding-left: 15px;
            padding-right: 15px;
            border-radius: 8px;
        }

        .item-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #7B61FF;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: white;
        }

        .item-checkbox.checked {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            border-color: transparent;
        }

        .item-checkbox.checked::after {
            content: "✓";
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .item-text {
            flex: 1;
            font-size: 14px;
            color: #333;
            transition: all 0.3s ease;
        }

        .item-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
            color: #666;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .list-item:hover .item-actions {
            opacity: 1;
        }

        .item-action {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .item-action.delete {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .item-action.delete:active {
            background: #f44336;
            color: white;
            transform: scale(0.9);
        }


        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* List Add Button */
        .list-add-btn {
            padding: 15px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7B61FF;
            font-size: 18px;
            font-weight: bold;
            min-height: 56px;
        }

        .list-add-btn:hover {
            background: rgba(123, 97, 255, 0.1);
            color: #5AE0E0;
        }

        .list-add-btn:active {
            transform: scale(0.98);
            background: rgba(123, 97, 255, 0.2);
        }

        /* List Completion Circle */
        .list-completion {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #7B61FF;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #7B61FF;
            z-index: 10;
        }

        .list-completion:hover {
            background: rgba(123, 97, 255, 0.1);
            transform: scale(1.1);
        }

        .list-completion.completed {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white;
            border-color: transparent;
        }

        .list-completion.completed::after {
            content: "✓";
            font-weight: bold;
        }


        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        /* Floating Archive Button */
        .floating-archive {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: rgba(255, 183, 77, 0.9);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(255, 183, 77, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-archive:active {
            transform: scale(0.9);
        }

        .floating-archive:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(255, 183, 77, 0.5);
        }

        /* Archive Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .archive-modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            transform: scale(0.9);
            animation: modalSlideIn 0.3s ease forwards;
        }

        @keyframes modalSlideIn {
            to { transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 100, 100, 0.1);
            border-radius: 50%;
            color: #ff6b6b;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .close-modal:active {
            transform: scale(0.9);
        }

        .archived-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .archived-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .archived-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .archived-item-title {
            font-weight: 600;
            color: #333;
        }

        .archived-item-date {
            font-size: 12px;
            color: #666;
        }

        .archived-item-count {
            font-size: 12px;
            color: #666;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(123, 97, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(123, 97, 255, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 100px 20px 60px;
            }

            .list-categories {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .nav-menu {
                display: none;
            }

            .item-actions {
                opacity: 1; /* Always visible on mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-left">
            <div class="mini-orb" onclick="window.location.href='index.html'"></div>
            <div class="nav-menu">
                <a href="index.html" class="nav-item">Chat</a>
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="lists.html" class="nav-item active">Lists</a>
                <a href="calendar.html" class="nav-item">Calendar</a>
                <a href="journal.html" class="nav-item">Journal</a>
                <button class="more-nav-btn" onclick="openMoreOverlay()">More</button>
            </div>
        </div>
        <div class="nav-right">
            <div class="api-indicator connecting" id="apiStatus">Connecting</div>
            <button class="settings-btn" onclick="window.location.href='settings.html'" title="Settings">⚙️</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Top Info Bar -->
        <div class="top-info-bar">
            <div class="time-display">
                <div class="current-time" id="currentTime">Loading...</div>
                <div class="current-date" id="currentDate">Loading...</div>
            </div>
            <div class="weather-widget">
                <div>☀️</div>
                <div>23°</div>
            </div>
        </div>

        <!-- List Categories -->
        <div class="list-categories">
            <!-- Personal Todos -->
            <div class="list-category">
                <div class="category-header">
                    <div class="category-title">
                        📝 Personal Todos
                    </div>
                </div>
                <div class="list-items" id="personalItems">
                    <!-- Personal todo items will be rendered here -->
                </div>
                <div class="list-add-btn" onclick="addItemToList('personal')" title="Add Item">
                    <span>+</span>
                </div>
                <div class="list-completion" onclick="completeList('personal')" title="Complete List"></div>
            </div>

            <!-- Shopping Lists -->
            <div class="list-category">
                <div class="category-header">
                    <div class="category-title">
                        🛒 Shopping Lists
                    </div>
                </div>
                <div class="list-items" id="shoppingItems">
                    <!-- Shopping items will be rendered here -->
                </div>
                <div class="list-add-btn" onclick="addItemToList('shopping')" title="Add Item">
                    <span>+</span>
                </div>
                <div class="list-completion" onclick="completeList('shopping')" title="Complete List"></div>
            </div>

            <!-- Bucket Lists -->
            <div class="list-category">
                <div class="category-header">
                    <div class="category-title">
                        🎯 Bucket List
                    </div>
                </div>
                <div class="list-items" id="bucketItems">
                    <!-- Bucket list items will be rendered here -->
                </div>
                <div class="list-add-btn" onclick="addItemToList('bucket')" title="Add Item">
                    <span>+</span>
                </div>
                <div class="list-completion" onclick="completeList('bucket')" title="Complete List"></div>
            </div>

            <!-- Work Tasks -->
            <div class="list-category">
                <div class="category-header">
                    <div class="category-title">
                        💼 Work Todos
                    </div>
                </div>
                <div class="list-items" id="workItems">
                    <!-- Work task items will be rendered here -->
                </div>
                <div class="list-add-btn" onclick="addItemToList('work')" title="Add Item">
                    <span>+</span>
                </div>
                <div class="list-completion" onclick="completeList('work')" title="Complete List"></div>
            </div>
        </div>
    </div>

    <!-- Floating Add Button -->
    <button class="fab" onclick="openQuickAdd()" title="Quick Add">+</button>

    <script src="js/common.js"></script>
    <script>
        // Lightweight GET cache and in-flight deduplication
        const __listsApiGetCache = new Map(); // key -> { timestamp, ttl, data }
        const __listsApiInFlight = new Map(); // key -> Promise
        function apiGetCached(path, ttlMs = 30000) {
            const key = path;
            const now = Date.now();
            const cached = __listsApiGetCache.get(key);
            if (cached && (now - cached.timestamp) < cached.ttl) {
                return Promise.resolve(cached.data);
            }
            if (__listsApiInFlight.has(key)) {
                return __listsApiInFlight.get(key);
            }
            const p = apiRequest(path)
                .then(data => {
                    __listsApiGetCache.set(key, { timestamp: Date.now(), ttl: ttlMs, data });
                    __listsApiInFlight.delete(key);
                    return data;
                })
                .catch(err => {
                    __listsApiInFlight.delete(key);
                    throw err;
                });
            __listsApiInFlight.set(key, p);
            return p;
        }
        // Global variables
        let lists = {
            personal: [],
            shopping: [],
            bucket: [],
            work: []
        };
        
        let listCompletionStates = {
            personal: false,
            shopping: false,
            bucket: false,
            work: false
        };

        let backendConnected = false;

        // Initialize page (use shared timers/status from common.js)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Lists page loaded');
            loadLists();
        });

        // Use shared updateTime from js/common.js

        // Use shared API status from js/common.js

        // Load lists from backend
        async function loadLists() {
            try {
                // Initialize empty lists
                lists = { personal: [], shopping: [], bucket: [], work: [] };
                
                // Load in parallel with caching
                const [personalRes, shoppingRes, bucketRes, workRes] = await Promise.all([
                    apiGetCached('/lists/personal_todos', 15000),
                    apiGetCached('/lists/shopping', 15000),
                    apiGetCached('/lists/bucket', 15000),
                    apiGetCached('/lists/work_todos', 15000)
                ]);
                
                const firstItems = (res) => (res && res.lists && res.lists[0] && res.lists[0].items) ? res.lists[0].items : [];
                lists.personal = firstItems(personalRes);
                lists.shopping = firstItems(shoppingRes);
                lists.bucket = firstItems(bucketRes);
                lists.work = firstItems(workRes);
                
                renderAllLists();
            } catch (error) {
                console.error('Failed to load lists:', error);
                lists = { personal: [], shopping: [], bucket: [], work: [] };
                renderAllLists();
            }
        }

        // Render all lists
        function renderAllLists() {
            renderList('personal');
            renderList('shopping');
            renderList('bucket');
            renderList('work');
        }

        // Render individual list
        function renderList(category) {
            const container = document.getElementById(`${category}Items`);
            const items = lists[category] || [];

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${category === 'personal' ? '📝' : category === 'shopping' ? '🛒' : category === 'bucket' ? '🎯' : '💼'}</div>
                        <div class="empty-state-text">No items yet</div>
                        <div class="empty-state-subtext">Add your first ${category === 'bucket' ? 'goal' : 'item'}</div>
                    </div>
                `;
            } else {
                container.innerHTML = items.map(item => `
                    <div class="list-item" data-id="${item.id}">
                        <div class="item-checkbox ${item.completed ? 'checked' : ''}" 
                             onclick="toggleItem('${category}', ${item.id})"></div>
                        <div class="item-text ${item.completed ? 'completed' : ''}">${item.text}</div>
                        <div class="item-actions">
                            <button class="item-action delete" onclick="deleteItem('${category}', ${item.id})" title="Delete">🗑️</button>
                        </div>
                    </div>
                `).join('');
            }

            // Update completion circle state
            const completionCircle = document.querySelector(`[onclick="completeList('${category}')"]`);
            if (completionCircle) {
                completionCircle.classList.toggle('completed', listCompletionStates[category]);
            }
        }



        // Add new item (used by quick add)
        async function addItem(category, text) {
            if (!text || !text.trim()) return;

            const newItem = {
                id: Date.now(), // Generate a temporary ID
                text: text.trim(),
                completed: false,
                priority: 'medium',
                category: category
            };

            try {
                // Add to local list first for immediate feedback
                lists[category].push(newItem);
                renderList(category);

                // Save to backend by updating the entire list
                await saveListToBackend(category);
                showNotification('Item added!', 'success');
            } catch (error) {
                console.error('Failed to add item:', error);
                showNotification('Failed to add item', 'error');
            }
        }

        // Save list to backend
        async function saveListToBackend(category) {
            try {
                // Map category to list type
                const listTypeMap = {
                    'personal': 'personal_todos',
                    'shopping': 'shopping',
                    'bucket': 'bucket', 
                    'work': 'work_todos'
                };
                
                const listType = listTypeMap[category];
                if (!listType) return;

                // Check if list exists
                const response = await apiRequest(`/lists/${listType}`);
                const existingLists = response.lists || [];
                
                if (existingLists.length > 0) {
                    // Update existing list
                    const listId = existingLists[0].id;
                    await apiRequest(`/lists/${listType}/${listId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            items: lists[category]
                        })
                    });
                } else {
                    // Create new list
                    await apiRequest(`/lists/${listType}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            list_type: listType,
                            category: 'personal',
                            name: `${category.charAt(0).toUpperCase() + category.slice(1)} List`,
                            items: lists[category]
                        })
                    });
                }
            } catch (error) {
                console.warn('Failed to save to backend:', error);
                // Don't throw - let the UI work locally
            }
        }

        // Toggle item completion
        async function toggleItem(category, itemId) {
            const item = lists[category].find(item => item.id === itemId);
            if (!item) return;

            item.completed = !item.completed;
            renderList(category);

            // Save to backend
            await saveListToBackend(category);
        }

        // Delete item
        async function deleteItem(category, itemId) {
            if (!confirm('Delete this item?')) return;

            // Remove from local list first
            lists[category] = lists[category].filter(item => item.id !== itemId);
            renderList(category);

            // Save to backend
            await saveListToBackend(category);
            showNotification('Item deleted', 'success');
        }

        // Complete list (archive for Zoe to review)
        async function completeList(category) {
            if (listCompletionStates[category]) {
                // Uncomplete list
                listCompletionStates[category] = false;
                renderList(category);
                showNotification('List uncompleted', 'info');
                return;
            }

            if (!confirm(`Complete ${category} list? This will archive it for Zoe to review.`)) return;

            try {
                // Mark all items in the category as completed
                lists[category].forEach(item => {
                    item.completed = true;
                });

                // Save completed items to backend
                await saveListToBackend(category);

                listCompletionStates[category] = true;
                lists[category] = []; // Clear the list
                renderList(category);
                showNotification(`${category} list completed and archived!`, 'success');
            } catch (error) {
                console.error('Failed to complete list:', error);
                showNotification('Failed to complete list', 'error');
            }
        }

        // Add item to specific list
        function addItemToList(category) {
            const item = prompt(`Add to ${category} list:`);
            if (!item || !item.trim()) return;

            addItem(category, item);
        }

        // Quick add function (for floating button)
        function openQuickAdd() {
            console.log('Quick add button clicked!');
            // Show a simple prompt for quick adding
            const item = prompt('Quick add item:');
            if (!item || !item.trim()) return;

            // Show list selection
            const listChoice = prompt('Add to which list?\n1. Personal Todos\n2. Shopping\n3. Bucket List\n4. Work Tasks\n\nEnter 1, 2, 3, or 4:');
            if (!listChoice) return;

            let category;
            switch(listChoice.trim()) {
                case '1':
                    category = 'personal';
                    break;
                case '2':
                    category = 'shopping';
                    break;
                case '3':
                    category = 'bucket';
                    break;
                case '4':
                    category = 'work';
                    break;
                default:
                    category = 'personal'; // Default to personal
            }

            // Add the item using the addItem function
            addItem(category, item);
        }

        // Placeholder functions for more overlay
        function openMoreOverlay() {
            console.log('More overlay - to be implemented');
        }
    </script>
</body>
</html>
