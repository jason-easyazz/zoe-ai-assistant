<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe - People Intelligence</title>
    <style>
        :root {
            --font-display: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-text: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            --bg-primary: #fafbfc;
            --bg-secondary: #f1f3f6;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --purple: #7c3aed;
            --rose: #ec4899;
            --teal: #14b8a6;
            --amber: #f59e0b;
            --green: #10b981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-text);
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }
        
        /* Navigation Bar */
        .nav-bar {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 12px 24px; z-index: 100;
            display: flex; justify-content: space-between;
            align-items: center; height: 60px;
        }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .mini-orb {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #0891b2 100%);
            cursor: pointer; transition: transform 0.2s;
            animation: breathe 4s ease-in-out infinite;
        }
        .mini-orb:hover { transform: scale(1.1); animation: none; }
        .nav-menu { display: flex; gap: 8px; }
        .nav-item {
            color: var(--text-secondary); text-decoration: none;
            font-size: 14px; font-weight: 500; padding: 8px 16px;
            border-radius: 8px; transition: all 0.2s;
            background: none; border: none; cursor: pointer;
        }
        .nav-item:hover { color: var(--purple); background: rgba(124, 58, 237, 0.1); }
        .nav-item.active { color: var(--purple); background: rgba(124, 58, 237, 0.1); }
        .nav-right { display: flex; align-items: center; gap: 10px; }
        
        .more-nav-btn { 
            color: var(--text-secondary); text-decoration: none;
            font-size: 14px; font-weight: 500; padding: 8px 16px;
            border-radius: 8px; transition: all 0.2s;
            background: none; border: none; cursor: pointer;
        }
        .more-nav-btn:hover { color: var(--purple); background: rgba(124, 58, 237, 0.1); }
        
        .notifications-btn { 
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: all 0.3s ease; color: var(--text-secondary);
            font-size: 16px; font-weight: bold; position: relative;
        }
        .notifications-btn:hover { background: rgba(255, 255, 255, 0.8); color: var(--text-primary); }
        
        .api-indicator { font-size: 12px; padding: 4px 8px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .api-indicator.online { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .api-indicator.offline { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .api-indicator.connecting { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .api-indicator::before { content: ''; width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .api-indicator.online::before { background: #22c55e; }
        .api-indicator.offline::before { background: #ef4444; }
        .api-indicator.connecting::before { background: #3b82f6; }
        
        .time-date-display {
            display: flex; flex-direction: column; align-items: flex-end; gap: 2px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
        }
        .current-time { font-size: 16px; font-weight: 500; color: #333; line-height: 1.2; }
        .current-date { font-size: 11px; color: #666; line-height: 1.2; }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.95; }
        }
        
        /* Main Layout */
        .main-layout { display: flex; height: calc(100vh - 60px); margin-top: 60px; }
        
        /* People Sidebar */
        .people-sidebar {
            width: 360px; background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border-right: 1px solid var(--glass-border);
            padding: 24px; overflow-y: auto;
        }
        .people-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 24px;
        }
        .people-title { font-size: 18px; font-weight: 600; font-family: var(--font-display); }
        
        .search-box {
            margin-bottom: 16px; position: relative;
        }
        .search-input {
            width: 100%; padding: 12px 40px 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 10px; background: rgba(255, 255, 255, 0.9);
            font-size: 14px; outline: none; transition: all 0.2s;
        }
        .search-input:focus {
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        .search-icon {
            position: absolute; right: 12px; top: 50%;
            transform: translateY(-50%); color: var(--text-tertiary);
            pointer-events: none; font-size: 16px;
        }
        
        .filter-chips {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;
        }
        .filter-chip {
            padding: 6px 12px; border-radius: 16px;
            font-size: 12px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }
        .filter-chip.active {
            background: var(--purple);
            color: white; border-color: var(--purple);
        }
        
        .person-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 16px;
            margin-bottom: 12px; transition: all 0.2s; cursor: pointer;
        }
        .person-card:hover { transform: translateX(4px); box-shadow: var(--shadow-md); }
        .person-card.urgent { border-left: 3px solid var(--amber); }
        .person-card.positive { border-left: 3px solid var(--green); }
        .person-label {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 6px;
        }
        .person-text { font-size: 14px; color: var(--text-primary); line-height: 1.5; }
        .person-action { margin-top: 8px; font-size: 13px; color: var(--purple); font-weight: 500; }
        
        /* Canvas Container */
        .canvas-container { flex: 1; position: relative; overflow: hidden; }
        #peopleCanvas { width: 100%; height: 100%; cursor: grab; }
        #peopleCanvas.dragging { cursor: grabbing; }
        
        .canvas-legend {
            position: absolute; bottom: 24px; left: 24px;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 16px; box-shadow: var(--shadow-md);
        }
        .legend-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; font-size: 13px; }
        .legend-circle { width: 16px; height: 16px; border-radius: 50%; border: 2px solid; }
        
        .canvas-controls { position: absolute; top: 24px; right: 24px; display: flex; gap: 8px; }
        .control-btn {
            width: 40px; height: 40px; background: var(--glass-bg);
            backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: all 0.2s;
            font-size: 18px; color: var(--text-primary);
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px); box-shadow: var(--shadow-md);
        }
        
        /* Floating Add Button */
        .floating-add-btn { 
            position: fixed; bottom: 30px; right: 30px; width: 72px; height: 72px; 
            border-radius: 50%; background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            border: none; color: white; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; font-size: 32px; transition: all 0.3s ease; 
            z-index: 1000; box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
        }
        .floating-add-btn:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(123, 97, 255, 0.4); }
        
        /* Detail Panel */
        .detail-panel {
            position: fixed; top: 60px; right: -600px; width: 600px;
            height: calc(100vh - 60px); background: var(--glass-bg);
            backdrop-filter: blur(40px); border-left: 1px solid var(--glass-border);
            z-index: 90; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
        }
        .detail-panel.open { right: 0; }
        .detail-header {
            background: linear-gradient(135deg, var(--purple) 0%, #0891b2 100%);
            padding: 24px; color: white; position: relative;
        }
        .detail-close {
            position: absolute; top: 12px; right: 12px;
            width: 32px; height: 32px; border: none;
            background: rgba(255, 255, 255, 0.2); border-radius: 50%;
            color: white; font-size: 18px; cursor: pointer; transition: all 0.2s;
        }
        .detail-close:hover { background: rgba(255, 255, 255, 0.3); transform: rotate(90deg); }
        .detail-avatar {
            width: 64px; height: 64px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; margin-bottom: 12px;
        }
        .detail-name {
            font-size: 24px; font-weight: 300;
            margin-bottom: 4px; font-family: var(--font-display);
        }
        .detail-subtitle { font-size: 13px; opacity: 0.9; }
        .detail-content { padding: 20px; }
        .detail-section { margin-bottom: 24px; }
        .section-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 10px;
        }
        .connection-health, .memory-details, .info-grid {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
            border-radius: 10px; padding: 14px;
        }
        .health-bar {
            height: 6px; background: #e5e7eb;
            border-radius: 3px; overflow: hidden; margin: 10px 0;
        }
        .health-fill {
            height: 100%; background: linear-gradient(90deg, var(--purple), #0891b2);
            transition: width 0.3s;
        }
        .health-stats {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; margin-top: 10px;
        }
        .stat-box { background: rgba(0, 0, 0, 0.02); padding: 10px; border-radius: 6px; }
        .stat-label { font-size: 10px; color: var(--text-tertiary); margin-bottom: 3px; }
        .stat-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .tags-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .tag {
            padding: 3px 10px; background: rgba(124, 58, 237, 0.1);
            color: var(--purple); border-radius: 10px;
            font-size: 11px; font-weight: 500;
        }
        .quick-actions {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 8px; margin-top: 12px;
        }
        .quick-action-btn {
            padding: 10px; background: rgba(255,255,255,0.9);
            border: 1px solid var(--glass-border); border-radius: 8px;
            text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .quick-action-btn:hover {
            background: rgba(124, 58, 237, 0.1);
            border-color: var(--purple);
        }
        .quick-action-icon { font-size: 18px; margin-bottom: 3px; }
        .quick-action-label { font-size: 10px; font-weight: 500; color: var(--text-secondary); }
        
        /* Edit mode styles */
        .detail-panel.editing .quick-action-btn:not([onclick*="editPerson"]) {
            opacity: 0.5;
            pointer-events: none;
        }
        .edit-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .edit-field:focus {
            outline: none;
            border-color: var(--purple);
            background: white;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        .edit-field::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        .notes-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        .info-item .edit-field {
            margin-top: 4px;
        }
        .timeline-item, .activity-item, .note-item, .gift-item {
            padding: 10px; background: rgba(255,255,255,0.9);
            border-radius: 8px; margin-bottom: 6px;
            display: flex; gap: 10px; align-items: start;
        }
        .timeline-icon {
            width: 28px; height: 28px; border-radius: 50%;
            background: rgba(124, 58, 237, 0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }
        .timeline-content { flex: 1; }
        .timeline-title { font-size: 13px; font-weight: 500; margin-bottom: 3px; }
        .timeline-meta { font-size: 11px; color: var(--text-tertiary); }
        .info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .info-item {
            padding: 10px; background: rgba(0,0,0,0.02); border-radius: 6px;
        }
        .info-label { font-size: 10px; color: var(--text-tertiary); margin-bottom: 4px; }
        .info-value { font-size: 13px; font-weight: 500; }
        .shared-goals {
            display: flex; flex-direction: column; gap: 8px;
        }
        .goal-item {
            padding: 10px; background: rgba(255,255,255,0.9);
            border-radius: 8px; display: flex; justify-content: space-between;
            align-items: center;
        }
        .goal-text { font-size: 13px; }
        .goal-status {
            padding: 3px 8px; border-radius: 6px;
            font-size: 10px; font-weight: 500;
        }
        .goal-status.planned { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        
        /* Add Person Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 200;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white; border-radius: 16px; padding: 24px;
            width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-title {
            font-size: 20px; font-weight: 600; margin-bottom: 20px;
        }
        .modal-field { margin-bottom: 16px; }
        .modal-label {
            font-size: 13px; font-weight: 500; color: var(--text-secondary);
            margin-bottom: 8px; display: block;
        }
        .modal-input {
            width: 100%; padding: 10px 12px; border: 1px solid var(--glass-border);
            border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s;
        }
        .modal-input:focus {
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        .modal-actions {
            display: flex; gap: 12px; margin-top: 24px;
        }
        .modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .modal-btn-primary {
            background: linear-gradient(135deg, var(--purple), #0891b2);
            color: white;
        }
        .modal-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        .modal-btn-secondary {
            background: rgba(0,0,0,0.05);
            color: var(--text-secondary);
        }
        .modal-btn-secondary:hover { background: rgba(0,0,0,0.1); }
        
        .tooltip {
            position: absolute; background: rgba(0, 0, 0, 0.9);
            color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 12px; pointer-events: none; z-index: 1000;
            white-space: nowrap; opacity: 0; transition: opacity 0.2s;
        }
        .tooltip.show { opacity: 1; }
        
        /* Mobile Navigation */
        .mobile-nav-menu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100vh;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.3); z-index: 2000;
            transition: left 0.3s ease; display: flex; flex-direction: column;
        }
        .mobile-nav-menu.open { left: 0; }
        .mobile-nav-header {
            padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: space-between; align-items: center;
        }
        .mobile-nav-header h3 { margin: 0; font-size: 20px; font-weight: 600; color: #333; }
        .mobile-nav-close {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: rgba(255, 255, 255, 0.3); color: #666; font-size: 24px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .mobile-nav-close:active { background: rgba(255, 255, 255, 0.5); }
        .mobile-nav-content { flex: 1; overflow-y: auto; padding: 10px; }
        .mobile-nav-item {
            display: flex; align-items: center; gap: 12px; padding: 16px; margin: 4px 0;
            color: #666; text-decoration: none; font-size: 16px; font-weight: 500;
            border-radius: 12px; transition: all 0.3s ease;
        }
        .mobile-nav-item:active { background: rgba(123, 97, 255, 0.1); color: #7B61FF; }
        .mobile-nav-item.active { background: rgba(123, 97, 255, 0.15); color: #7B61FF; font-weight: 600; }
        .mobile-nav-item.logout { color: #ff4444; }
        .mobile-nav-divider { height: 1px; background: rgba(255, 255, 255, 0.3); margin: 10px 0; }
        .mobile-nav-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); z-index: 1999; opacity: 0;
            pointer-events: none; transition: opacity 0.3s ease;
        }
        .mobile-nav-overlay.open { opacity: 1; pointer-events: auto; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu { display: none !important; }
            .mini-orb { display: flex !important; }
        }
        @media (min-width: 769px) {
            .mobile-nav-menu, .mobile-nav-overlay { display: none !important; }
        }
        
        /* Onboarding Prompt Modal */
        .onboarding-prompt-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000; animation: fadeIn 0.3s ease;
        }
        .onboarding-prompt-content {
            background: var(--glass-bg); backdrop-filter: blur(40px);
            border-radius: 20px; padding: 40px; max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        .onboarding-zoe-orb {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #0891b2 100%);
            margin: 0 auto 20px; animation: breathe 4s ease-in-out infinite;
        }
        .onboarding-prompt-content h2 {
            font-size: 24px; font-weight: 600; margin-bottom: 12px;
            color: var(--text-primary);
        }
        .onboarding-prompt-content p {
            font-size: 15px; color: var(--text-secondary);
            margin-bottom: 24px; line-height: 1.6;
        }
        .onboarding-prompt-actions {
            display: flex; gap: 12px; margin-bottom: 16px;
        }
        .onboarding-btn-primary, .onboarding-btn-secondary {
            flex: 1; padding: 12px 24px; border-radius: 10px;
            font-size: 15px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: none;
        }
        .onboarding-btn-primary {
            background: linear-gradient(135deg, var(--purple), #0891b2);
            color: white;
        }
        .onboarding-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4); }
        .onboarding-btn-secondary {
            background: rgba(255, 255, 255, 0.6);
            color: var(--text-secondary);
        }
        .onboarding-btn-secondary:hover { background: rgba(255, 255, 255, 0.8); }
        .onboarding-skip-option {
            display: block; font-size: 13px; color: var(--text-tertiary);
            cursor: pointer;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Zoe AI">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zoe">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#7B61FF">
    <meta name="msapplication-TileColor" content="#7B61FF">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Icons & Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/icons/icon-maskable-512.png" color="#7B61FF">
    
    <!-- Service Worker Registration -->
    <script src="/js/sw-registration.js" defer></script>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-left">
            <div class="mini-orb" onclick="toggleMobileMenu()"></div>
            <div class="nav-menu">
                <a href="index.html" class="nav-item">Chat</a>
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="lists.html" class="nav-item">Lists</a>
                <a href="calendar.html" class="nav-item">Calendar</a>
                <a href="journal.html" class="nav-item">Journal</a>
                <button class="more-nav-btn" onclick="openMoreOverlay()">More</button>
            </div>
        </div>
        <div class="nav-right">
            <div class="api-indicator connecting" id="apiStatus">Connecting</div>
            
            <button class="notifications-btn" onclick="openNotifications()" title="Notifications">üí¨</button>
            
            <!-- Time/Date Display -->
            <div class="time-date-display">
                <div class="current-time" id="currentTime">Loading...</div>
                <div class="current-date" id="currentDate">Loading...</div>
            </div>
        </div>
    </div>
    
    <div class="main-layout">
        <div class="people-sidebar">
            <div class="people-header">
                <h2 class="people-title">People Intelligence</h2>
            </div>
            
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search people..." oninput="searchPeople(this.value)">
                <span class="search-icon">üîç</span>
            </div>
            
            <div id="filterChips" class="filter-chips"></div>
            <div id="peopleList"></div>
        </div>
        
        <div class="canvas-container">
            <canvas id="peopleCanvas"></canvas>
            
            <div class="canvas-controls">
                <div class="control-btn" onclick="resetView()" title="Reset View">‚ü≤</div>
                <div class="control-btn" onclick="zoomIn()" title="Zoom In">+</div>
                <div class="control-btn" onclick="zoomOut()" title="Zoom Out">‚àí</div>
            </div>
            <div class="canvas-legend" id="canvasLegend"></div>
        </div>
    </div>
    
    <!-- Add Person Modal -->
    <div class="modal-overlay" id="addPersonModal">
        <div class="modal">
            <div class="modal-title">Add Person</div>
            <div class="modal-field">
                <label class="modal-label">Name *</label>
                <input type="text" class="modal-input" id="personName" placeholder="Enter person's name" required>
            </div>
            <div class="modal-field">
                <label class="modal-label">Category</label>
                <select class="modal-input" id="personCategory">
                    <option value="inner">Inner Circle</option>
                    <option value="circle">Circle</option>
                    <option value="acquaintance">Acquaintances</option>
                    <option value="professional">Professional</option>
                    <option value="archive">Archive</option>
                </select>
            </div>
            <div class="modal-field">
                <label class="modal-label">Birthday</label>
                <input type="date" class="modal-input" id="personBirthday">
            </div>
            <div class="modal-field">
                <label class="modal-label">Phone</label>
                <input type="tel" class="modal-input" id="personPhone" placeholder="555-1234">
            </div>
            <div class="modal-field">
                <label class="modal-label">Email</label>
                <input type="email" class="modal-input" id="personEmail" placeholder="name@example.com">
            </div>
            <div class="modal-field">
                <label class="modal-label">Address</label>
                <input type="text" class="modal-input" id="personAddress" placeholder="123 Main Street">
            </div>
            <div class="modal-field">
                <label class="modal-label">Notes</label>
                <textarea class="modal-input" id="personNotes" placeholder="Add any notes about this person" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeAddPersonModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="createPerson()">Add Person</button>
            </div>
        </div>
    </div>
    
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
            <button class="detail-close" onclick="closeDetail()">√ó</button>
            <div class="detail-avatar" id="detailIcon"></div>
            <h1 class="detail-name" id="detailName"></h1>
            <div class="detail-subtitle" id="detailSubtitle"></div>
        </div>
        <div class="detail-content" id="detailContent"></div>
    </div>
    
    <!-- Mobile Navigation Menu -->
    <div class="mobile-nav-menu" id="mobileNavMenu">
        <div class="mobile-nav-header">
            <h3>Navigation</h3>
            <button class="mobile-nav-close" onclick="toggleMobileMenu()">‚úï</button>
        </div>
        <div class="mobile-nav-content">
            <a href="chat.html" class="mobile-nav-item">üí¨ Chat</a>
            <a href="dashboard.html" class="mobile-nav-item">üìä Dashboard</a>
            <a href="lists.html" class="mobile-nav-item">‚úÖ Lists</a>
            <a href="calendar.html" class="mobile-nav-item">üìÖ Calendar</a>
            <a href="journal.html" class="mobile-nav-item">üìî Journal</a>
            <a href="people.html" class="mobile-nav-item active">üë• People</a>
            <a href="memories.html" class="mobile-nav-item">üß† Memories</a>
            <a href="settings.html" class="mobile-nav-item">‚öôÔ∏è Settings</a>
            <div class="mobile-nav-divider"></div>
            <a href="#" class="mobile-nav-item logout" onclick="handleLogout()">üö™ Sign Out</a>
        </div>
    </div>
    <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="toggleMobileMenu()"></div>

    <!-- More Overlay -->
    <div class="more-overlay" id="moreOverlay">
        <div class="more-content">
            <button class="more-close" onclick="closeMoreOverlay()">√ó</button>
            <div class="more-header">
                <h2 class="more-title">More Options</h2>
            </div>
            <div class="more-grid">
                <div class="more-item" onclick="navigateToPage('people.html')">
                    <div class="more-item-icon">üë•</div>
                    <div class="more-item-label">People</div>
                </div>
                <div class="more-item" onclick="navigateToPage('memories.html')">
                    <div class="more-item-icon">üß†</div>
                    <div class="more-item-label">Memories</div>
                </div>
                <div class="more-item" onclick="navigateToPage('workflows.html')">
                    <div class="more-item-icon">‚ö°</div>
                    <div class="more-item-label">Workflows</div>
                </div>
                <div class="more-item" onclick="navigateToPage('music.html')">
                    <div class="more-item-icon">üéµ</div>
                    <div class="more-item-label">Music</div>
                </div>
                <div class="more-item" onclick="navigateToPage('settings.html')">
                    <div class="more-item-icon">‚öôÔ∏è</div>
                    <div class="more-item-label">Settings</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Floating Add Button -->
    <button class="floating-add-btn" onclick="openAddPersonModal()" title="Add Person">+</button>
    
    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script>
        const canvas = document.getElementById('peopleCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY;
        let scale = 1, offsetX = 0, offsetY = 0;
        let isDragging = false, dragStartX = 0, dragStartY = 0;
        let draggedItem = null, hoveredItem = null;
        let animationFrame;
        let breathePhase = 0;
        let activeFilters = ['inner', 'circle', 'acquaintance', 'professional'];
        let mouseDownTime = 0;
        let mouseDownItem = null;
        const DRAG_THRESHOLD = 200;
        
        let people = [];
        let currentUser = null;
        
        // Load data from API
        async function loadPeople() {
            console.log("=== Loading People ===");
            try {
                const response = await apiRequest('/api/people');
                console.log("API Response:", response);
                
                if (!response || !response.people) {
                    console.error("Invalid API response:", response);
                    people = [];
                    return;
                }
                
                people = response.people.map(person => ({
                    id: `p${person.id}`,
                    type: 'person',
                    category: person.relationship || person.metadata?.category || 'inner',
                    name: person.name,
                    angle: person.metadata?.angle || Math.random() * 360,
                    distance: person.metadata?.distance || 100 + Math.random() * 100,
                    lastContact: person.metadata?.lastContact || 7,
                    frequency: person.metadata?.frequency || 14,
                    strength: person.metadata?.strength || 0.5,
                    birthday: person.birthday,
                    relationshipType: person.relationship,
                    phone: person.phone,
                    email: person.email,
                    address: person.address,
                    notes: person.notes,
                    relationships: person.metadata?.relationships || []
                }));
                
                console.log(`‚úÖ Loaded ${people.length} people`);
                
                if (people.length === 0) {
                    showNotification('üëã No people yet! Click + to add your first person', 'info');
                }
            } catch (error) {
                console.error("Error loading people:", error);
                people = [];
                showNotification('‚ö†Ô∏è Failed to load people', 'error');
            }
        }
        
        async function loadEnhancedPerson(personId) {
            try {
                const session = window.zoeAuth?.getCurrentSession();
                const userId = session?.user_info?.user_id || session?.user_id;
                const response = await fetch(`/api/people/${personId}/analysis?user_id=${userId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const person = data.person;
                return {
                    id: `p${person.id}`,
                    type: 'person',
                    category: person.metadata?.category || 'inner',
                    name: person.name,
                    angle: person.metadata?.angle || Math.random() * 360,
                    distance: person.metadata?.distance || 100 + Math.random() * 100,
                    lastContact: person.metadata?.lastContact || 7,
                    frequency: person.metadata?.frequency || 14,
                    strength: person.metadata?.strength || 0.5,
                    birthday: person.birthday,
                    relationshipType: person.relationship,
                    phone: person.phone,
                    email: person.email,
                    notes: person.notes,
                    timeline: person.timeline,
                    activities: person.activities,
                    conversations: person.conversations,
                    gifts: person.gifts,
                    importantDates: person.important_dates,
                    relationships: person.relationships.map(r => `p${r.person_id}`)
                };
            } catch (error) {
                console.error('Failed to load enhanced person:', error);
                return null;
            }
        }
        
        function resizeCanvas() {
            width = canvas.parentElement.clientWidth;
            height = canvas.parentElement.clientHeight;
            canvas.width = width * window.devicePixelRatio;
            canvas.height = height * window.devicePixelRatio;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            centerX = width / 2;
            centerY = height / 2;
        }
        
        function openAddPersonModal() {
            document.getElementById('addPersonModal').classList.add('show');
        }

        function closeAddPersonModal() {
            document.getElementById('addPersonModal').classList.remove('show');
            document.getElementById('personName').value = '';
            document.getElementById('personCategory').value = 'inner';
            document.getElementById('personBirthday').value = '';
            document.getElementById('personPhone').value = '';
            document.getElementById('personEmail').value = '';
            document.getElementById('personAddress').value = '';
            document.getElementById('personNotes').value = '';
        }
        
        async function createPerson() {
            const name = document.getElementById('personName').value.trim();
            const category = document.getElementById('personCategory').value;
            const birthday = document.getElementById('personBirthday').value;
            const phone = document.getElementById('personPhone').value.trim();
            const email = document.getElementById('personEmail').value.trim();
            const address = document.getElementById('personAddress').value.trim();
            const notes = document.getElementById('personNotes').value.trim();
            
            if (!name) {
                showNotification('‚ö†Ô∏è Name is required', 'error');
                return;
            }
            
            try {
                const personData = {
                    name: name,
                    relationship: category,
                    birthday: birthday || null,
                    phone: phone || null,
                    email: email || null,
                    address: address || null,
                    notes: notes || null,
                    metadata: {
                        strength: category === 'inner' ? 0.9 : category === 'circle' ? 0.7 : category === 'acquaintance' ? 0.5 : category === 'professional' ? 0.6 : 0.3,
                        frequency: category === 'inner' ? 7 : category === 'circle' ? 14 : category === 'acquaintance' ? 30 : category === 'professional' ? 21 : 90,
                        lastContact: category === 'inner' ? 3 : category === 'circle' ? 7 : category === 'acquaintance' ? 14 : category === 'professional' ? 10 : 30
                    }
                };
                
                const result = await apiRequest('/api/people', {
                    method: 'POST',
                    body: JSON.stringify(personData)
                });
                
                if (result && result.person) {
                    const newPerson = {
                        id: `p${result.person.id}`,
                        name: name,
                        category: category,
                        birthday: birthday,
                        phone: phone,
                        email: email,
                        address: address,
                        notes: notes,
                        relationshipType: category,
                        strength: personData.metadata.strength,
                        frequency: personData.metadata.frequency,
                        lastContact: personData.metadata.lastContact,
                        angle: Math.random() * Math.PI * 2,
                        distance: 100 + Math.random() * 100,
                        relationships: []
                    };
                    
                    people.push(newPerson);
                    closeAddPersonModal();
                    updateSidebar();
                    updateLegend();
                    showNotification(`‚úÖ Added ${name}!`, 'success');
                } else {
                    throw new Error('Invalid response from server');
                }
            } catch (error) {
                console.error('Failed to create person:', error);
                showNotification('‚ùå Failed to add person', 'error');
            }
        }
        
        function animate() {
            breathePhase += 0.02;
            draw();
            animationFrame = requestAnimationFrame(animate);
        }
        
        function draw() {
            const bgGradient = ctx.createLinearGradient(0, 0, width, height);
            bgGradient.addColorStop(0, '#fafbfc');
            bgGradient.addColorStop(1, '#f1f3f6');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, width, height);
            
            ctx.save();
            ctx.translate(centerX + offsetX, centerY + offsetY);
            ctx.scale(scale, scale);
            
            drawPeopleView();
            
            ctx.restore();
        }
        
        function drawPeopleView() {
            const blendedGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, 250);
            blendedGlow.addColorStop(0, 'rgba(236, 72, 153, 0.15)');
            blendedGlow.addColorStop(0.3, 'rgba(168, 85, 247, 0.12)');
            blendedGlow.addColorStop(0.6, 'rgba(20, 184, 166, 0.12)');
            blendedGlow.addColorStop(1, 'rgba(20, 184, 166, 0)');
            ctx.fillStyle = blendedGlow;
            ctx.beginPath();
            ctx.arc(0, 0, 250, 0, Math.PI * 2);
            ctx.fill();
            
            const visiblePeople = people.filter(p => activeFilters.includes(p.category));
            visiblePeople.forEach(p => {
                if (p.relationships) {
                    p.relationships.forEach(relId => {
                        const related = people.find(person => person.id === relId);
                        if (related && activeFilters.includes(related.category)) {
                            const pos1 = getPolarPosition(p);
                            const pos2 = getPolarPosition(related);
                            ctx.strokeStyle = 'rgba(124, 58, 237, 0.15)';
                            ctx.lineWidth = 2;
                            ctx.setLineDash([5, 5]);
                            ctx.beginPath();
                            ctx.moveTo(pos1.x, pos1.y);
                            ctx.lineTo(pos2.x, pos2.y);
                            ctx.stroke();
                            ctx.setLineDash([]);
                        }
                    });
                }
            });
            
            visiblePeople.forEach(p => {
                const pos = getPolarPosition(p);
                const o = p.strength * 0.25;
                const g = ctx.createLinearGradient(0, 0, pos.x, pos.y);
                if (p.category === 'inner') {
                    g.addColorStop(0, `rgba(124, 58, 237, ${o*0.8})`);
                    g.addColorStop(1, `rgba(236, 72, 153, ${o})`);
                    ctx.lineWidth = 1.5;
                } else {
                    g.addColorStop(0, `rgba(124, 58, 237, ${o*0.6})`);
                    g.addColorStop(1, `rgba(20, 184, 166, ${o*0.8})`);
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                }
                ctx.strokeStyle = g;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            });
            ctx.setLineDash([]);
            
            visiblePeople.forEach(p => drawPerson(p));
            drawYouNode();
        }
        
        function drawYouNode() {
            const r = 48;
            const breathe = 1 + Math.sin(breathePhase) * 0.02;
            
            // Draw completeness ring if available
            if (userProfile && userProfile.profile_completeness > 0) {
                const completeness = userProfile.profile_completeness || 0;
                ctx.beginPath();
                ctx.arc(0, 0, r + 8, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(124, 58, 237, 0.1)';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // Draw completeness arc
                ctx.beginPath();
                ctx.arc(0, 0, r + 8, -Math.PI/2, -Math.PI/2 + (completeness * 2 * Math.PI));
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.stroke();
            }
            
            // Main node
            ctx.beginPath();
            ctx.arc(0, 0, r * breathe, 0, Math.PI * 2);
            const g = ctx.createRadialGradient(-r*0.3, -r*0.3, 0, 0, 0, r);
            g.addColorStop(0, '#a855f7');
            g.addColorStop(0.5, '#8b5cf6');
            g.addColorStop(1, '#7c3aed');
            ctx.fillStyle = g;
            ctx.fill();
            
            // Add glow effect
            ctx.beginPath();
            ctx.arc(0, 0, r * breathe * 1.3, 0, Math.PI * 2);
            const glowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, r * breathe * 1.3);
            glowGradient.addColorStop(0, 'rgba(168, 85, 247, 0.3)');
            glowGradient.addColorStop(1, 'rgba(168, 85, 247, 0)');
            ctx.fillStyle = glowGradient;
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px var(--font-text)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Display user's name if available
            const userName = (userProfile && userProfile.name) ? userProfile.name : 'You';
            ctx.fillText(userName.length > 8 ? userName.substring(0, 8) + '...' : userName, 0, 0);
        }
        
        function drawPerson(p) {
            const pos = getPolarPosition(p);
            const floatOffset = !isDragging && !draggedItem ? Math.sin(breathePhase * 1.5 + p.angle) * 3 : 0;
            pos.y += floatOffset;
            
            const r = 28;
            const hov = hoveredItem?.id === p.id;
            const ring = p.category === 'inner' ? '#ec4899' : 
                         p.category === 'circle' ? '#14b8a6' : 
                         p.category === 'acquaintance' ? '#9ca3af' :
                         p.category === 'professional' ? '#3b82f6' :
                         p.category === 'archive' ? '#6b7280' : '#9ca3af';
            const needsAttention = p.lastContact > p.frequency * 1.5;
            const pulseScale = needsAttention ? 1 + Math.sin(breathePhase * 2) * 0.05 : 1;
            const hoverScale = hov ? 1.15 : 1;
            const finalScale = pulseScale * hoverScale;
            
            if (needsAttention) {
                const pulseSize = r * 2 * (1 + Math.sin(breathePhase * 2) * 0.1);
                const og = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, pulseSize);
                og.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
                og.addColorStop(1, 'rgba(245, 158, 11, 0)');
                ctx.fillStyle = og;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, pulseSize, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, r * finalScale, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = ring;
            ctx.lineWidth = hov ? 4 : 3.5;
            ctx.stroke();
            
            ctx.fillStyle = '#1f2937';
            ctx.font = '600 14px var(--font-text)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(255, 255, 255, 0.9)';
            ctx.shadowBlur = 4;
            ctx.fillText(p.name, pos.x, pos.y + r * finalScale + 20);
            ctx.shadowBlur = 0;
        }
        
        function getPolarPosition(item) {
            const a = (item.angle * Math.PI) / 180;
            return { x: Math.cos(a) * item.distance, y: Math.sin(a) * item.distance };
        }
        
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - centerX - offsetX) / scale;
            const my = (e.clientY - rect.top - centerY - offsetY) / scale;
            const item = getItemAtPosition(mx, my);
            
            mouseDownTime = Date.now();
            mouseDownItem = item;
            
            if (!item) {
                isDragging = true;
                dragStartX = e.clientX - offsetX;
                dragStartY = e.clientY - offsetY;
            }
        });
        
        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - centerX - offsetX) / scale;
            const my = (e.clientY - rect.top - centerY - offsetY) / scale;
            
            if (isDragging) {
                offsetX = e.clientX - dragStartX;
                offsetY = e.clientY - dragStartY;
            } else {
                const item = getItemAtPosition(mx, my);
                if (item !== hoveredItem) {
                    hoveredItem = item;
                    if (item) {
                        showTooltip(e.clientX, e.clientY, item.name);
                    } else hideTooltip();
                }
            }
        });
        
        canvas.addEventListener('mouseup', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - centerX - offsetX) / scale;
            const my = (e.clientY - rect.top - centerY - offsetY) / scale;
            const distFromCenter = Math.sqrt(mx * mx + my * my);
            const clickDuration = Date.now() - mouseDownTime;
            
            // Check if clicking on center "You" node
            if (!mouseDownItem && distFromCenter < 48 && clickDuration < DRAG_THRESHOLD) {
                showUserProfile();
                return;
            }
            
            if (mouseDownItem && clickDuration < DRAG_THRESHOLD) {
                if (mouseDownItem.type === 'person') {
                    console.log('Canvas click: showing person', mouseDownItem.name);
                    showPersonDetail(mouseDownItem);
                }
            } else if (!mouseDownItem && clickDuration < DRAG_THRESHOLD) {
                const panel = document.getElementById('detailPanel');
                if (panel.classList.contains('open')) {
                    closeDetail();
                }
            }
            
            isDragging = false;
            mouseDownItem = null;
        });
        
        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            hoveredItem = null;
            mouseDownItem = null;
            hideTooltip();
        });
        
        function getItemAtPosition(mx, my) {
            for (const p of people.filter(p => activeFilters.includes(p.category))) {
                const pos = getPolarPosition(p);
                const dist = Math.sqrt(Math.pow(mx - pos.x, 2) + Math.pow(my - pos.y, 2));
                if (dist < 28) {
                    console.log('Found person at position:', p.name, 'distance:', dist);
                    return p;
                }
            }
            return null;
        }
        
        function showPersonById(personId) {
            const person = people.find(p => p.id === personId);
            if (person) {
                showPersonDetail(person);
            } else {
                console.error('Person not found:', personId);
                showNotification('‚ö†Ô∏è Person not found', 'error');
            }
        }
        
        async function showPersonDetail(person) {
            if (!person) {
                console.error('showPersonDetail called with no person');
                return;
            }
            
            const panel = document.getElementById('detailPanel');
            const icon = document.getElementById('detailIcon');
            const name = document.getElementById('detailName');
            const subtitle = document.getElementById('detailSubtitle');
            const content = document.getElementById('detailContent');
            const isEditing = panel.classList.contains('editing');
            
            icon.textContent = 'üë§';
            
            if (isEditing) {
                name.innerHTML = `<input type="text" id="editPersonName" value="${person.name}" class="edit-field" placeholder="Full name">`;
                subtitle.innerHTML = `<select id="editPersonCategory" class="edit-field">
                    <option value="inner" ${person.category === 'inner' ? 'selected' : ''}>Inner Circle</option>
                    <option value="circle" ${person.category === 'circle' ? 'selected' : ''}>Circle</option>
                    <option value="acquaintance" ${person.category === 'acquaintance' ? 'selected' : ''}>Acquaintances</option>
                    <option value="professional" ${person.category === 'professional' ? 'selected' : ''}>Professional</option>
                    <option value="archive" ${person.category === 'archive' ? 'selected' : ''}>Archive</option>
                </select>`;
            } else {
                name.textContent = person.name;
                subtitle.textContent = person.relationshipType || 'Friend';
            }
            
            // Load enhanced person data
            const personId = person.id.replace('p', '');
            const enhancedPerson = await loadEnhancedPerson(personId);
            if (enhancedPerson) {
                person = enhancedPerson;
            }
            
            let htmlSections = [];
            
            htmlSections.push(`
                <div class="detail-section">
                    <div class="section-title">Connection Health</div>
                    <div class="connection-health">
                        <div>Based on your usual pattern</div>
                        <div class="health-bar"><div class="health-fill" style="width: ${Math.min(100, person.strength * 100)}%"></div></div>
                        <div class="health-stats">
                            <div class="stat-box"><div class="stat-label">Last Contact</div><div class="stat-value">${Math.floor(person.lastContact / 7)}w ago</div></div>
                            <div class="stat-box"><div class="stat-label">Frequency</div><div class="stat-value">Every ${Math.floor(person.frequency / 7)}w</div></div>
                            <div class="stat-box"><div class="stat-label">Strength</div><div class="stat-value">${Math.round(person.strength * 100)}%</div></div>
                        </div>
                        <div class="tags-container">
                            <span class="tag">${person.category === 'inner' ? 'Inner Circle' : 
                                               person.category === 'circle' ? 'Circle' : 
                                               person.category === 'acquaintance' ? 'Acquaintances' :
                                               person.category === 'professional' ? 'Professional' :
                                               person.category === 'archive' ? 'Archive' : person.category}</span>
                            ${person.birthday ? `<span class="tag">üéÇ ${person.birthday}</span>` : ''}
                        </div>
                    </div>
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="scheduleWithPerson('${person.id}')"><div class="quick-action-icon">üìÖ</div><div class="quick-action-label">Schedule</div></div>
                        <div class="quick-action-btn" onclick="createTodoForPerson('${person.id}')"><div class="quick-action-icon">‚úì</div><div class="quick-action-label">To-Do</div></div>
                        <div class="quick-action-btn" onclick="addNoteToPerson('${person.id}')"><div class="quick-action-icon">üìù</div><div class="quick-action-label">Note</div></div>
                        <div class="quick-action-btn" onclick="setGoalWithPerson('${person.id}')"><div class="quick-action-icon">üéØ</div><div class="quick-action-label">Goal</div></div>
                        <div class="quick-action-btn" onclick="addGiftForPerson('${person.id}')"><div class="quick-action-icon">üéÅ</div><div class="quick-action-label">Gift</div></div>
                        <div class="quick-action-btn" onclick="logConversationWithPerson('${person.id}')"><div class="quick-action-icon">üí¨</div><div class="quick-action-label">Log</div></div>
                        <div class="quick-action-btn" onclick="trackDebtWithPerson('${person.id}')"><div class="quick-action-icon">üí∞</div><div class="quick-action-label">Debt</div></div>
                        <div class="quick-action-btn" onclick="editPerson('${person.id}')"><div class="quick-action-icon">${isEditing ? 'üíæ' : '‚úèÔ∏è'}</div><div class="quick-action-label">${isEditing ? 'Save' : 'Edit'}</div></div>
                    </div>
                </div>
            `);
            
            // Contact & Background section
            htmlSections.push(`
                <div class="detail-section">
                    <div class="section-title">Contact & Background</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Phone</div>
                            <div class="info-value">
                                ${isEditing ? `<input type="tel" id="editPersonPhone" value="${person.phone || ''}" class="edit-field" placeholder="Phone number">` : (person.phone || 'Not provided')}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value">
                                ${isEditing ? `<input type="email" id="editPersonEmail" value="${person.email || ''}" class="edit-field" placeholder="Email address">` : (person.email || 'Not provided')}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Birthday</div>
                            <div class="info-value">
                                ${isEditing ? `<input type="date" id="editPersonBirthday" value="${person.birthday || ''}" class="edit-field">` : (person.birthday || 'Not provided')}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Address</div>
                            <div class="info-value">
                                ${isEditing ? `<input type="text" id="editPersonAddress" value="${person.address || ''}" class="edit-field" placeholder="Address">` : (person.address || 'Not provided')}
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            // Notes section
            htmlSections.push(`
                <div class="detail-section">
                    <div class="section-title">Notes & Preferences</div>
                    <div class="notes-section">
                        ${isEditing ? `
                            <textarea id="editPersonNotes" class="edit-field notes-textarea" placeholder="Add notes about this person...">${person.notes || ''}</textarea>
                        ` : `
                            <div class="note-item">
                                <div class="timeline-title">${person.notes || 'No notes yet'}</div>
                            </div>
                        `}
                    </div>
                </div>
            `);
            
            content.innerHTML = htmlSections.join('');
            panel.classList.add('open');
        }
        
        // Person detail action functions
        function scheduleWithPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const title = prompt(`Schedule something with ${person.name}:`, 'Coffee meeting');
            if (title) {
                const date = prompt('When? (e.g., "Next Tuesday 2pm" or "2024-01-15 14:00"):', '');
                if (date) {
                    alert(`Scheduled: ${title} with ${person.name} on ${date}`);
                }
            }
        }
        
        function createTodoForPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const todo = prompt(`Create a to-do related to ${person.name}:`, 'Call to check in');
            if (todo) {
                const priority = prompt('Priority (1-5, where 5 is highest):', '3');
                if (priority) {
                    alert(`Created to-do: ${todo} (Priority: ${priority})`);
                }
            }
        }
        
        function addNoteToPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const note = prompt(`Add a note about ${person.name}:`, '');
            if (note) {
                alert(`Note added: ${note}`);
            }
        }
        
        function setGoalWithPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const goal = prompt(`Set a goal with ${person.name}:`, 'Plan a trip together');
            if (goal) {
                const deadline = prompt('Deadline (optional):', '');
                alert(`Goal set: ${goal}${deadline ? ` (Deadline: ${deadline})` : ''}`);
            }
        }
        
        function addGiftForPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const gift = prompt(`Gift idea for ${person.name}:`, '');
            if (gift) {
                const occasion = prompt('Occasion (optional):', 'Birthday');
                alert(`Gift idea added: ${gift}${occasion ? ` for ${occasion}` : ''}`);
            }
        }
        
        function logConversationWithPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const topic = prompt(`What did you talk about with ${person.name}?`, '');
            if (topic) {
                const notes = prompt('Additional notes (optional):', '');
                alert(`Conversation logged: ${topic}${notes ? `\nNotes: ${notes}` : ''}`);
            }
        }
        
        function trackDebtWithPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            const amount = prompt(`Debt amount with ${person.name} (positive = they owe you, negative = you owe them):`, '0');
            if (amount !== null) {
                const reason = prompt('Reason (optional):', '');
                alert(`Debt tracked: ${amount}${reason ? ` (${reason})` : ''}`);
            }
        }
        
        function editPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) {
                console.error('editPerson: Person not found:', personId);
                showNotification('‚ö†Ô∏è Person not found', 'error');
                return;
            }
            
            const panel = document.getElementById('detailPanel');
            const isEditing = panel.classList.contains('editing');
            
            if (isEditing) {
                savePersonChanges(personId);
            } else {
                panel.classList.add('editing');
                showPersonDetail(person);
            }
        }
        
        async function savePersonChanges(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) {
                console.error('savePersonChanges: Person not found:', personId);
                showNotification('‚ö†Ô∏è Person not found', 'error');
                return;
            }
            
            const name = document.getElementById('editPersonName')?.value || person.name;
            const category = document.getElementById('editPersonCategory')?.value || person.category;
            const phone = document.getElementById('editPersonPhone')?.value || '';
            const email = document.getElementById('editPersonEmail')?.value || '';
            const birthday = document.getElementById('editPersonBirthday')?.value || '';
            const address = document.getElementById('editPersonAddress')?.value || '';
            const notes = document.getElementById('editPersonNotes')?.value || '';
            
            if (!name) {
                showNotification('‚ö†Ô∏è Name is required', 'error');
                return;
            }
            
            try {
                // Extract numeric ID from personId (remove 'p' prefix)
                const id = personId.replace('p', '');
                
                // Prepare update data
                const updateData = {
                    name: name,
                    relationship: category,
                    phone: phone || null,
                    email: email || null,
                    birthday: birthday || null,
                    address: address || null,
                    notes: notes || null
                };
                
                // Call backend API to update
                await apiRequest(`/api/people/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                // Update local object
                person.name = name;
                person.category = category;
                person.relationshipType = category;
                person.phone = phone;
                person.email = email;
                person.birthday = birthday;
                person.address = address;
                person.notes = notes;
                
                // Exit edit mode and refresh display
                const panel = document.getElementById('detailPanel');
                panel.classList.remove('editing');
                showPersonDetail(person);
                updateSidebar();
                updateLegend();
                
                showNotification(`‚úÖ Updated ${name}!`, 'success');
            } catch (error) {
                console.error('Failed to update person:', error);
                showNotification('‚ùå Failed to update person', 'error');
            }
        }
        
        function updateSidebar() {
            const list = document.getElementById('peopleList');
            const filters = document.getElementById('filterChips');
            
            filters.innerHTML = `
                <div class="filter-chip ${activeFilters.includes('inner') ? 'active' : ''}" onclick="toggleFilter('inner')">Inner Circle</div>
                <div class="filter-chip ${activeFilters.includes('circle') ? 'active' : ''}" onclick="toggleFilter('circle')">Circle</div>
                <div class="filter-chip ${activeFilters.includes('acquaintance') ? 'active' : ''}" onclick="toggleFilter('acquaintance')">Acquaintances</div>
                <div class="filter-chip ${activeFilters.includes('professional') ? 'active' : ''}" onclick="toggleFilter('professional')">Professional</div>
                <div class="filter-chip ${activeFilters.includes('archive') ? 'active' : ''}" onclick="toggleFilter('archive')">Archive</div>
            `;
            
            list.innerHTML = people.filter(person => activeFilters.length === 0 || activeFilters.includes(person.category)).map(person => `
                <div class="person-card" onclick="showPersonById('${person.id}')">
                    <div class="person-label">${person.name}</div>
                    <div class="person-text">${person.relationshipType || person.category}${person.birthday ? ` ‚Ä¢ Birthday: ${person.birthday}` : ""}</div>
                    <div class="person-action">View Details</div>
                </div>
            `).join("");
        }
        
        function toggleFilter(category) {
            const index = activeFilters.indexOf(category);
            if (index > -1) {
                activeFilters.splice(index, 1);
            } else {
                activeFilters.push(category);
            }
            updateSidebar();
        }
        
        function updateLegend() {
            const legend = document.getElementById('canvasLegend');
            legend.innerHTML = `
                <div class="legend-title">Relationship Map</div>
                <div class="legend-item">
                    <div class="legend-circle" style="border-color: #ec4899; background: white;"></div>
                    <span>Inner Circle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="border-color: #14b8a6; background: white;"></div>
                    <span>Circle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="border-color: #9ca3af; background: white;"></div>
                    <span>Acquaintances</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="border-color: #3b82f6; background: white;"></div>
                    <span>Professional</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="border-color: #6b7280; background: white;"></div>
                    <span>Archive</span>
                </div>
            `;
        }
        
        function showUserProfile() {
            const panel = document.getElementById('detailPanel');
            const icon = document.getElementById('detailIcon');
            const name = document.getElementById('detailName');
            const subtitle = document.getElementById('detailSubtitle');
            const content = document.getElementById('detailContent');
            
            if (!userProfile) {
                alert('Profile not loaded. Please refresh the page.');
                return;
            }
            
            icon.textContent = 'üë§';
            name.textContent = userProfile.name || 'Your Profile';
            subtitle.textContent = 'Profile Management';
            
            // Create profile content
            const html = `
                <div class="detail-section">
                    <div class="section-title">Your Profile</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Name</div>
                            <div class="info-value">${userProfile.name || 'Not set'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Bio</div>
                            <div class="info-value">${userProfile.bio || 'Not set'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value">${userProfile.location || 'Not set'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Birthday</div>
                            <div class="info-value">${userProfile.birthday || 'Not set'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Profile Completeness</div>
                            <div class="info-value">${Math.round((userProfile.profile_completeness || 0) * 100)}%</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Confidence Score</div>
                            <div class="info-value">${Math.round((userProfile.confidence_score || 0) * 100)}%</div>
                        </div>
                    </div>
                </div>
                
                ${userProfile.ai_insights ? `
                <div class="detail-section">
                    <div class="section-title">AI Insights</div>
                    <div class="connection-health">
                        <p>Based on my analysis of your conversations, journal entries, and activities, here's what I've learned about you:</p>
                        ${userProfile.ai_insights.observed_patterns ? `
                        <div class="tags-container">
                            ${userProfile.ai_insights.observed_patterns.slice(0, 5).map(pattern => `
                                <span class="tag">${pattern.type}</span>
                            `).join('')}
                        </div>
                        ` : '<p class="info-value">No insights yet. Keep using Zoe!</p>'}
                    </div>
                </div>
                ` : ''}
                
                <div class="detail-section">
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="enrichProfile()"><div class="quick-action-icon">‚ú®</div><div class="quick-action-label">Enrich</div></div>
                        <div class="quick-action-btn" onclick="editUserProfile()"><div class="quick-action-icon">‚úèÔ∏è</div><div class="quick-action-label">Edit</div></div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            panel.classList.add('open');
        }
        
        async function enrichProfile() {
            try {
                await apiRequest('/api/user/profile/analyze', {
                    method: 'POST'
                });
                alert('Analysis started! Your profile will be updated with new insights.');
                await loadUserProfile();
                showUserProfile();
            } catch (error) {
                console.error('Failed to start analysis:', error);
                alert('Failed to start analysis');
            }
        }
        
        function editUserProfile() {
            // Redirect to settings page for profile editing
            window.location.href = 'settings.html?tab=profile';
        }
        
        function closeDetail() { 
            const panel = document.getElementById('detailPanel');
            panel.classList.remove('open');
            panel.classList.remove('editing');
        }
        
        function showTooltip(x, y, t) { 
            const el = document.getElementById('tooltip'); 
            el.textContent = t; 
            el.style.left = x + 'px'; 
            el.style.top = (y - 40) + 'px'; 
            el.classList.add('show'); 
        }
        function hideTooltip() { document.getElementById('tooltip').classList.remove('show'); }
        function resetView() { scale = 1; offsetX = 0; offsetY = 0; }
        function zoomIn() { scale = Math.min(2, scale * 1.2); }
        function zoomOut() { scale = Math.max(0.5, scale / 1.2); }
        function searchPeople(q) { console.log('Search:', q); }
        
        // Show notification (imported from common.js but add fallback)
        if (typeof showNotification === 'undefined') {
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 80px; right: 20px; 
                    background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#7B61FF'};
                    color: white; padding: 12px 20px; border-radius: 12px;
                    font-size: 14px; font-weight: 500; z-index: 9999;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    max-width: 300px; word-wrap: break-word;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            if (window.innerWidth > 768) { window.location.href = 'index.html'; return; }
            const menu = document.getElementById('mobileNavMenu');
            const overlay = document.getElementById('mobileNavOverlay');
            if (menu && overlay) {
                menu.classList.toggle('open');
                overlay.classList.toggle('open');
            }
        }

        function handleLogout() {
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
            logout();
        }

        // More overlay functions
        function openMoreOverlay() {
            document.getElementById('moreOverlay').classList.add('active');
        }

        function closeMoreOverlay() {
            document.getElementById('moreOverlay').classList.remove('active');
        }

        function navigateToPage(page) {
            window.location.href = page;
        }

        // Time/Date Update Functions
        function updateTimeDate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
            
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            
            if (timeElement) timeElement.textContent = timeString;
            if (dateElement) dateElement.textContent = dateString;
        }

        // User profile storage
        let userProfile = null;
        
        async function loadUserProfile() {
            try {
                const response = await apiRequest('/api/user/profile');
                userProfile = response;
                
                // Check if onboarding is needed
                if (!userProfile.onboarding_completed) {
                    showOnboardingPrompt();
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }
        
        function showOnboardingPrompt() {
            const modal = document.createElement('div');
            modal.className = 'onboarding-prompt-modal';
            modal.innerHTML = `
                <div class="onboarding-prompt-content">
                    <div class="onboarding-zoe-orb"></div>
                    <h2>Hi! I'm Zoe üëã</h2>
                    <p>Would you like to do your onboarding now? It helps me learn about you so I can be more helpful!</p>
                    <div class="onboarding-prompt-actions">
                        <button class="onboarding-btn-primary" onclick="startOnboarding()">Let's do it!</button>
                        <button class="onboarding-btn-secondary" onclick="closeOnboardingPrompt(this)">Maybe later</button>
                    </div>
                    <label class="onboarding-skip-option">
                        <input type="checkbox" onchange="toggleOnboardingReminder(this.checked)">
                        Don't ask again
                    </label>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function startOnboarding() {
            window.location.href = 'chat.html?onboarding=true';
        }
        
        function closeOnboardingPrompt(btn) {
            btn.closest('.onboarding-prompt-modal').remove();
        }
        
        function toggleOnboardingReminder(checked) {
            if (checked) {
                // Mark profile as onboarding completed (minimal)
                apiRequest('/api/user/profile', {
                    method: 'PUT',
                    body: JSON.stringify({ onboarding_completed: true })
                });
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            updateAPIStatus();
            await loadUserProfile();
            await loadPeople();
            updateSidebar();
            updateLegend();
            updateTimeDate();
            setInterval(updateTimeDate, 60000);
        });

        async function updateAPIStatus() {
            const statusEl = document.getElementById('apiStatus');
            try {
                await apiRequest('/health');
                statusEl.textContent = 'Online';
                statusEl.className = 'api-indicator online';
            } catch (error) {
                statusEl.textContent = 'Offline';
                statusEl.className = 'api-indicator offline';
            }
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        animate();
    </script>
    <!-- Mini Player for persistent music playback -->
    <script src="js/mini-player.js"></script>
</body>
</html>


