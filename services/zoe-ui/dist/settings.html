<!DOCTYPE html>
<html>
<head>
    <title>API Key Settings</title>
    <style>
        body {
            font-family: Arial;
            max-width: 800px;
            margin: 50px auto;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .key-row {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .service-name {
            width: 150px;
            font-weight: bold;
        }
        input {
            flex: 1;
            padding: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .configured { background: #2a4a2a; }
        .not-configured { background: #4a2a2a; }
        .testing { background: #4a4a2a; }
        .valid { background: #2a6a2a; }
        .invalid { background: #6a2a2a; }
    </style>
</head>
<body>
    <h1>üîê API Key Management</h1>
    
    <div id="openai" class="key-row">
        <div class="service-name">OpenAI</div>
        <input type="password" id="openai-key" placeholder="sk-...">
        <button onclick="saveKey('openai')">Save</button>
        <button onclick="testKey('openai')">Test</button>
        <button onclick="removeKey('openai')">Remove</button>
        <span id="openai-status" class="status"></span>
    </div>
    
    <div id="anthropic" class="key-row">
        <div class="service-name">Anthropic</div>
        <input type="password" id="anthropic-key" placeholder="sk-ant-...">
        <button onclick="saveKey('anthropic')">Save</button>
        <button onclick="testKey('anthropic')">Test</button>
        <button onclick="removeKey('anthropic')">Remove</button>
        <span id="anthropic-status" class="status"></span>
    </div>
    
    <script>
        // Use the Pi's IP address, not localhost
        const API = 'http://192.168.1.60:8000/api';
        
        async function loadStatus() {
            try {
                const resp = await fetch(`${API}/settings/apikeys`);
                const data = await resp.json();
                
                for (const [svc, info] of Object.entries(data)) {
                    const status = document.getElementById(`${svc}-status`);
                    if (status) {
                        status.className = `status ${info.configured ? 'configured' : 'not-configured'}`;
                        status.textContent = info.configured ? '‚úÖ Configured' : '‚ùå Not Set';
                    }
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }
        
        async function saveKey(service) {
            const input = document.getElementById(`${service}-key`);
            if (!input.value) {
                alert('Enter a key');
                return;
            }
            
            try {
                const resp = await fetch(`${API}/settings/apikeys`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({service, key: input.value})
                });
                
                const status = document.getElementById(`${service}-status`);
                if (resp.ok) {
                    status.className = 'status configured';
                    status.textContent = '‚úÖ Saved';
                    input.value = '';
                    setTimeout(loadStatus, 1000);
                } else {
                    const err = await resp.json();
                    status.className = 'status invalid';
                    status.textContent = '‚ùå ' + (err.detail || 'Error');
                }
            } catch (error) {
                console.error('Error saving:', error);
                alert('Failed to save - check connection');
            }
        }
        
        async function testKey(service) {
            const status = document.getElementById(`${service}-status`);
            status.className = 'status testing';
            status.textContent = '‚è≥ Testing...';
            
            try {
                const resp = await fetch(`${API}/settings/apikeys/${service}/test`, {
                    method: 'POST'
                });
                const data = await resp.json();
                
                status.className = `status ${data.valid ? 'valid' : 'invalid'}`;
                status.textContent = data.valid ? '‚úÖ Working!' : '‚ùå Invalid';
                
                setTimeout(loadStatus, 3000);
            } catch (error) {
                console.error('Error testing:', error);
                status.className = 'status invalid';
                status.textContent = '‚ùå Connection error';
            }
        }
        
        async function removeKey(service) {
            if (!confirm(`Remove ${service} key?`)) return;
            
            try {
                await fetch(`${API}/settings/apikeys/${service}`, {
                    method: 'DELETE'
                });
                loadStatus();
            } catch (error) {
                console.error('Error removing:', error);
            }
        }
        
        loadStatus();
    </script>
</body>
</html>
