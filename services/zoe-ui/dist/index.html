<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Zoe AI Assistant</title>
    <style>
        * { 
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: linear-gradient(135deg, #fafbfc 0%, #f1f3f6 100%);
            min-height: 100vh; color: #333;
            font-size: clamp(14px, 1.6vw, 16px);
        }
        
        /* Navigation */
        .nav-bar {
            position: fixed; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px; z-index: 100; display: flex; justify-content: space-between;
            align-items: center; height: 60px;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .mini-orb { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            cursor: pointer; transition: all 0.3s ease; min-width: 44px; min-height: 44px;
        }
        .mini-orb:hover { transform: scale(1.1); }
        .nav-menu { display: flex; gap: 20px; }
        .nav-item { 
            color: #666; text-decoration: none; font-size: 13px; font-weight: 400; 
            transition: all 0.3s ease; padding: 8px 12px; border-radius: 6px;
            min-height: 44px; display: flex; align-items: center;
        }
        .nav-item:hover, .nav-item.active { color: #7B61FF; background: rgba(123, 97, 255, 0.1); }
        .nav-right { display: flex; align-items: center; gap: 10px; }
        
        .more-nav-btn { 
            color: #666; text-decoration: none; font-size: 13px; font-weight: 400; 
            transition: all 0.3s ease; padding: 8px 12px; border-radius: 6px;
            min-height: 44px; display: flex; align-items: center; cursor: pointer;
            background: none; border: none;
        }
        .more-nav-btn:hover { color: #7B61FF; background: rgba(123, 97, 255, 0.1); }
        
        .settings-btn { 
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: all 0.3s ease; color: #666;
            font-size: 16px; font-weight: bold;
        }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.8); color: #333; }
        
        .api-indicator { font-size: 12px; padding: 4px 8px; border-radius: 8px; font-weight: 500; }
        .api-indicator.online { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .api-indicator.offline { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .api-indicator.warning { background: rgba(251, 146, 60, 0.1); color: #ea580c; }

        /* Main Layout */
        .main-container { 
            padding: 70px 20px 20px; height: 100vh; display: flex; flex-direction: column;
        }
        
        .top-info-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding: 0 10px;
        }
        .time-display { display: flex; flex-direction: column; }
        .current-time { font-size: 18px; font-weight: 300; color: #333; }
        .current-date { font-size: 11px; color: #666; margin-top: 2px; }
        .weather-widget { display: flex; align-items: center; gap: 6px; }

        /* Chat Container */
        .chat-container {
            flex: 1; display: flex; flex-direction: column; 
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 16px;
            overflow: hidden; margin-bottom: 20px;
        }
        
        .chat-header {
            padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center; background: rgba(255, 255, 255, 0.8);
        }
        .chat-title {
            font-size: 20px; font-weight: 300; color: #333;
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .chat-subtitle {
            font-size: 12px; color: #666; margin-top: 4px;
        }
        
        .chat-messages {
            flex: 1; padding: 20px; overflow-y: auto; min-height: 300px;
            display: flex; flex-direction: column; gap: 16px;
        }
        
        .message {
            max-width: 85%; padding: 16px 20px; border-radius: 16px; 
            font-size: 15px; line-height: 1.5; word-wrap: break-word;
        }
        .zoe-message { 
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%); 
            color: white; margin-right: auto; align-self: flex-start;
        }
        .user-message {
            background: rgba(255, 255, 255, 0.8); color: #333; margin-left: auto;
            align-self: flex-end; border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .typing-indicator {
            display: none; margin-right: auto; align-self: flex-start;
        }
        .typing-indicator.active { display: block; }
        .typing-dots {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white; padding: 16px 20px; border-radius: 16px;
            font-size: 15px;
        }
        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 20% { content: '...'; }
            40% { content: '....'; }
            60% { content: '.....'; }
            80%, 100% { content: '......'; }
        }

        /* Input Area */
        .chat-input-container {
            padding: 20px; background: rgba(255, 255, 255, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; gap: 12px; align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1; position: relative;
        }
        
        .chat-input {
            width: 100%; padding: 16px 20px; border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px; background: rgba(255, 255, 255, 0.9); 
            font-size: 16px; outline: none; resize: none; min-height: 56px;
            max-height: 120px; font-family: inherit;
        }
        .chat-input:focus {
            border-color: #7B61FF; box-shadow: 0 0 0 2px rgba(123, 97, 255, 0.1);
        }
        
        .input-actions {
            display: flex; gap: 8px; align-items: center;
        }
        
        .voice-btn, .send-btn {
            width: 56px; height: 56px; border-radius: 50%; border: none;
            cursor: pointer; transition: all 0.3s ease; display: flex;
            align-items: center; justify-content: center; font-size: 20px;
        }
        
        .voice-btn {
            background: rgba(255, 255, 255, 0.6); color: #666;
        }
        .voice-btn:hover { background: rgba(255, 255, 255, 0.8); }
        .voice-btn.recording { 
            background: #ef4444; color: white; animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .send-btn {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white;
        }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* More Overlay */
        .more-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 3000;
            opacity: 0; transition: all 0.3s ease;
        }
        .more-overlay.active { display: flex; opacity: 1; }
        .more-content {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(60px);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 20px;
            padding: 40px; max-width: 500px; width: 90%; position: relative;
            transform: scale(0.8); transition: transform 0.3s ease;
        }
        .more-overlay.active .more-content { transform: scale(1); }
        .more-header { text-align: center; margin-bottom: 30px; }
        .more-title {
            font-size: 24px; font-weight: 300; color: #333; margin-bottom: 10px;
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .more-close {
            position: absolute; top: 15px; right: 15px; 
            background: rgba(255, 255, 255, 0.6); border: none;
            border-radius: 50%; width: 36px; height: 36px;
            font-size: 18px; cursor: pointer; color: #666;
        }
        .more-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .more-item {
            background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px; padding: 24px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; min-height: 120px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .more-item:hover {
            background: linear-gradient(135deg, #7B61FF 0%, #5AE0E0 100%);
            color: white; transform: translateY(-4px);
        }
        .more-item-icon { font-size: 36px; margin-bottom: 12px; }
        .more-item-label { font-size: 15px; font-weight: 500; }

        /* Mobile Responsive */
        @media (max-width: 800px) {
            .nav-menu { display: none; }
            .main-container { padding: 60px 10px 20px; }
            .chat-input-container { padding: 15px; }
            .more-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-left">
            <div class="mini-orb" onclick="window.location.href='index.html'"></div>
            <div class="nav-menu">
                <a href="index.html" class="nav-item active">Chat</a>
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="lists.html" class="nav-item">Lists</a>
                <a href="calendar.html" class="nav-item">Calendar</a>
                <a href="journal.html" class="nav-item">Journal</a>
                <button class="more-nav-btn" onclick="openMoreOverlay()">More</button>
            </div>
        </div>
        <div class="nav-right">
            <div class="api-indicator" id="apiStatus">🔄 Connecting</div>
            <button class="settings-btn" onclick="window.location.href='settings.html'" title="Settings">⚙️</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Top Info Bar -->
        <div class="top-info-bar">
            <div class="time-display">
                <div class="current-time" id="currentTime">Loading...</div>
                <div class="current-date" id="currentDate">Loading...</div>
            </div>
            <div class="weather-widget" id="weatherWidget">
                <div>🌤️</div>
                <div>--°</div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header">
                <h1 class="chat-title">Zoe AI Assistant</h1>
                <p class="chat-subtitle">Your personal AI companion</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message zoe-message">
                    Hi! I'm Zoe, your AI assistant. I can help you with:
                    <br>• Managing your calendar and events
                    <br>• Creating and organizing lists
                    <br>• Journaling and memories
                    <br>• Home automation
                    <br>• And much more!
                    <br><br>What would you like to do today?
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">Zoe is typing</div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Ask me anything..."
                        onkeydown="handleKeyDown(event)"
                        oninput="adjustTextareaHeight(this)"
                    ></textarea>
                </div>
                <div class="input-actions">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="Voice Input">🎤</button>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send Message">➤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- More Overlay -->
    <div class="more-overlay" id="moreOverlay">
        <div class="more-content">
            <button class="more-close" onclick="closeMoreOverlay()">×</button>
            <div class="more-header">
                <h2 class="more-title">More Options</h2>
            </div>
            <div class="more-grid">
                <div class="more-item" onclick="navigateToPage('memories.html')">
                    <div class="more-item-icon">🧠</div>
                    <div class="more-item-label">Memories</div>
                </div>
                <div class="more-item" onclick="navigateToPage('workflows.html')">
                    <div class="more-item-icon">⚡</div>
                    <div class="more-item-label">Workflows</div>
                </div>
                <div class="more-item" onclick="navigateToPage('settings.html')">
                    <div class="more-item-icon">⚙️</div>
                    <div class="more-item-label">Settings</div>
                </div>
                <div class="more-item" onclick="alert('Coming soon!')">
                    <div class="more-item-icon">📊</div>
                    <div class="more-item-label">Analytics</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let isRecording = false;
        let recognition = null;

        // Initialize voice recognition if available
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
                adjustTextareaHeight(document.getElementById('chatInput'));
            };

            recognition.onend = function() {
                isRecording = false;
                updateVoiceButton();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                updateVoiceButton();
                showNotification('Voice recognition error. Please try again.', 'error');
            };
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function toggleVoiceRecording() {
            if (!recognition) {
                showNotification('Voice recognition not supported in this browser', 'error');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
                isRecording = true;
                updateVoiceButton();
            }
        }

        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtn');
            if (isRecording) {
                voiceBtn.classList.add('recording');
                voiceBtn.title = 'Stop Recording';
            } else {
                voiceBtn.classList.remove('recording');
                voiceBtn.title = 'Voice Input';
            }
        }

        // Generate a session ID for this chat session
        let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            adjustTextareaHeight(input);

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await apiRequest('/chat', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        message: message,
                        context: { mode: 'main_chat' },
                        session_id: sessionId
                    })
                });

                hideTypingIndicator();
                
                if (response && response.response) {
                    addMessage(response.response, 'zoe');
                } else {
                    addMessage('I understand! Let me help you with that.', 'zoe');
                }

                // Handle special responses
                if (response && response.event_created) {
                    showNotification('Event created! 📅', 'success');
                } else if (response && response.task_created) {
                    showNotification('Task created! ✅', 'success');
                } else if (response && response.list_created) {
                    showNotification('List created! 📝', 'success');
                }

            } catch (error) {
                hideTypingIndicator();
                console.error('Chat error:', error);
                addMessage('Sorry, I encountered an error. Please check your connection and try again.', 'zoe');
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('active');
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        function navigateToPage(page) {
            window.location.href = page;
        }

        // Update weather widget
        async function updateWeather() {
            try {
                const response = await apiRequest('/weather/');
                if (response && response.temperature && response.condition) {
                    const weatherWidget = document.getElementById('weatherWidget');
                    if (weatherWidget) {
                        const icon = weatherWidget.querySelector('div:first-child');
                        const temp = weatherWidget.querySelector('div:last-child');
                        
                        // Map weather conditions to emojis
                        const weatherIcons = {
                            'sunny': '☀️',
                            'clear': '☀️',
                            'cloudy': '☁️',
                            'partly-cloudy': '⛅',
                            'rainy': '🌧️',
                            'stormy': '⛈️',
                            'snowy': '❄️',
                            'foggy': '🌫️'
                        };
                        
                        const condition = response.condition.toLowerCase().replace(/\s+/g, '-');
                        icon.textContent = weatherIcons[condition] || '🌤️';
                        temp.textContent = `${Math.round(response.temperature)}°`;
                        
                        // Add location tooltip if available
                        if (response.location) {
                            weatherWidget.title = `${response.location} - ${response.description}`;
                        }
                    }
                }
            } catch (error) {
                console.log('Weather data not available');
            }
        }

        // Focus input on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chatInput').focus();
            updateWeather();
            setInterval(updateWeather, 300000); // Update weather every 5 minutes
        });
    </script>
</body>
</html>